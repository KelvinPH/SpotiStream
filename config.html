<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SpotiStream Configurator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ 
    --bg: #0a0b0f; 
    --bg-secondary: #0f1117; 
    --panel: #141822; 
    --panel-hover: #1a1f2e;
    --border: rgba(255,255,255,0.06); 
    --border-hover: rgba(255,255,255,0.12);
    --muted: #6b7280; 
    --text: #f8fafc; 
    --text-secondary: #cbd5e1;
    --accent: #3b82f6; 
    --accent-hover: #2563eb;
    --success: #10b981;
    --radius: 16px; 
    --radius-sm: 12px;
    --shadow: 0 20px 25px -5px rgba(0,0,0,0.4), 0 10px 10px -5px rgba(0,0,0,0.2);
    --shadow-sm: 0 4px 6px -1px rgba(0,0,0,0.3);
  }
  
  *{box-sizing:border-box} 
  html,body{height:100%; margin:0; padding:0}
  
  body{
    background: radial-gradient(ellipse at top, var(--bg-secondary) 0%, var(--bg) 100%);
    color: var(--text); 
    font: 500 15px/1.6 'Inter', system-ui, -apple-system, sans-serif; 
    -webkit-font-smoothing: antialiased; 
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
  }
  
  .app{
    display: grid; 
    grid-template-columns: 480px 1fr; 
    gap: 24px; 
    height: 100vh; 
    padding: 24px;
    max-width: 1800px;
    margin: 0 auto;
  }
  
  .card{
    background: var(--panel); 
    border: 1px solid var(--border); 
    border-radius: var(--radius); 
    box-shadow: var(--shadow);
    backdrop-filter: blur(20px);
    transition: all 0.2s ease;
  }
  
  .card:hover{
    border-color: var(--border-hover);
    transform: translateY(-1px);
  }
  
  .left{
    display: grid; 
    grid-auto-rows: min-content; 
    gap: 20px; 
    overflow-y: auto; 
    overflow-x: hidden;
    padding-right: 8px;
  }
  
  .left::-webkit-scrollbar{width: 6px}
  .left::-webkit-scrollbar-track{background: transparent}
  .left::-webkit-scrollbar-thumb{background: var(--border-hover); border-radius: 3px}
  .left::-webkit-scrollbar-thumb:hover{background: var(--muted)}
  
  .section{
    padding: 24px; 
    display: grid; 
    gap: 20px;
  }
  
  .section h3{
    margin: 0; 
    font-size: 14px; 
    font-weight: 600;
    letter-spacing: 0.025em; 
    color: var(--text-secondary); 
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .section h3::before{
    content: '';
    width: 4px;
    height: 16px;
    background: linear-gradient(135deg, var(--accent), var(--success));
    border-radius: 2px;
  }
  
  .grid{display: grid; gap: 16px} 
  .grid.cols-2{grid-template-columns: 1fr 1fr}
  
  label{
    font-size: 13px; 
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 6px;
    display: block;
  }
  
  input[type="text"], input[type="url"], select{
    width: 100%; 
    padding: 12px 16px; 
    border-radius: var(--radius-sm); 
    background: var(--bg-secondary); 
    color: var(--text); 
    border: 1px solid var(--border);
    font-size: 14px;
    transition: all 0.2s ease;
  }
  
  input[type="text"]:focus, input[type="url"]:focus, select:focus{
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  input[type="range"]{
    width: 100%;
    height: 6px;
    background: var(--bg-secondary);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
  }
  
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
  }
  
  input[type="range"]::-webkit-slider-thumb:hover{
    background: var(--accent-hover);
    transform: scale(1.1);
  }
  
  .row{
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    gap: 12px;
    padding: 8px 0;
  }
  
  .check{
    display: flex; 
    align-items: center; 
    gap: 12px;
    padding: 8px 0;
  }
  
  .sw{
    appearance: none; 
    width: 48px; 
    height: 24px; 
    background: var(--bg-secondary); 
    border: 1px solid var(--border);
    border-radius: 12px; 
    position: relative; 
    outline: none; 
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .sw:checked{
    background: var(--accent);
    border-color: var(--accent);
  }
  
  .sw::after{
    content: ""; 
    position: absolute; 
    top: 2px; 
    left: 2px; 
    width: 18px; 
    height: 18px; 
    border-radius: 50%; 
    background: #fff; 
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
  }
  
  .sw:checked::after{left: 26px}
  
  .color-row{
    display: flex; 
    gap: 12px; 
    align-items: center; 
    flex-wrap: wrap;
  }
  
  .color-row input[type="color"]{
    width: 44px; 
    height: 44px; 
    border: 2px solid var(--border); 
    padding: 0; 
    border-radius: var(--radius-sm); 
    background: var(--bg-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .color-row input[type="color"]:hover{
    border-color: var(--border-hover);
    transform: scale(1.05);
  }
  
  .btn{
    appearance: none; 
    border: 0; 
    background: var(--accent); 
    color: white; 
    font-weight: 600; 
    padding: 12px 20px; 
    border-radius: var(--radius-sm); 
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn:hover{
    background: var(--accent-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
  }
  
  .btn.secondary{
    background: var(--success); 
    color: white;
  }
  
  .btn.secondary:hover{
    background: #059669;
  }
  
  .btn.ghost{
    background: transparent; 
    color: var(--text-secondary); 
    border: 1px solid var(--border);
  }
  
  .btn.ghost:hover{
    background: var(--panel-hover);
    border-color: var(--border-hover);
    color: var(--text);
  }
  
  .btn.small{
    padding: 8px 12px; 
    font-size: 13px;
  }
  
  .chips{
    display: flex; 
    gap: 10px; 
    flex-wrap: wrap;
    margin-top: 8px;
  }
  
  .mono{
    font-family: 'SF Mono', ui-monospace, Menlo, Consolas, monospace; 
    background: var(--bg-secondary); 
    border: 1px solid var(--border); 
    padding: 16px; 
    border-radius: var(--radius-sm); 
    color: var(--text); 
    overflow: auto;
    font-size: 13px;
    line-height: 1.5;
  }
  
  .right{
    display: grid; 
    grid-template-rows: auto 1fr; 
    gap: 20px;
  }
  
  .preview-bar{
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 20px 24px;
  }
  
  .preview-wrap{
    padding: 8px 16px 20px 16px; 
    height: 100%;
  }
  
  iframe{
    width: 100%; 
    height: 100%; 
    border: 0; 
    border-radius: var(--radius-sm); 
    background: var(--bg-secondary);
  }
  
  .badge{
    font-size: 13px; 
    color: var(--muted);
    font-weight: 500;
  }
  
  .range-display{
    background: var(--bg-secondary);
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    color: var(--accent);
    min-width: 60px;
    text-align: center;
  }
  
  .muted{
    opacity: 0.4; 
    pointer-events: none; 
    filter: grayscale(1);
  }
  
  @media (max-width: 1200px){ 
    .app{
      grid-template-columns: 1fr; 
      grid-template-rows: auto 60vh;
      gap: 20px;
      padding: 16px;
    }
  }
</style>
</head>
<body>
  <div class="app">
    <div class="left">
      <div class="card section">
        <h3>Overlay URL</h3>
        <div class="grid">
          <label>Hosted base URL</label>
          <input id="base" type="url" placeholder="https://<user>.github.io/SpotiStream/overlay.html" value="https://kelvinph.github.io/SpotiStream/overlay.html"/>
        </div>
        <div class="chips">
          <button class="btn small ghost" data-preset="record">Record (Spotify)</button>
          <button class="btn small ghost" data-preset="card">Card (OBS Dark)</button>
          <button class="btn small ghost" data-preset="bar">Bar Minimal</button>
          <button class="btn small ghost" data-preset="stacked">Stacked Vintage</button>
          <button class="btn small ghost" data-preset="transparent">Transparent HUD</button>
        </div>
        <div class="grid">
          <label>Generated URL</label>
          <div id="url" class="mono" style="white-space:nowrap"></div>
          <div class="row">
            <button id="copy" class="btn">Copy URL</button>
            <button id="open" class="btn secondary">Open</button>
            <button id="reset" class="btn ghost">Reset</button>
          </div>
          <div class="badge">Paste this into OBS → Browser Source → URL</div>
        </div>
      </div>

      <div class="card section">
        <h3>Layout</h3>
        <div class="grid cols-2">
          <div>
            <label>Layout</label>
            <select id="layout">
              <option value="record">record (vinyl)</option>
              <option value="card">card (cover)</option>
              <option value="bar">bar (minimal)</option>
              <option value="stacked">stacked (center)</option>
            </select>
          </div>
          <div>
            <label>Media position</label>
            <select id="align">
              <option value="left">left</option>
              <option value="right">right</option>
            </select>
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label>Theme</label>
            <select id="theme">
              <option>spotify</option><option>obsdark</option><option>minimal</option><option>neon</option><option>oldradio</option>
              <option>blue</option><option>red</option><option>yellow</option><option>slate</option>
              <option>twitch</option><option>ytred</option><option>aqua</option><option>cyber</option><option>pastel</option>
            </select>
          </div>
          <div>
            <label>Accent style</label>
            <select id="accentstyle">
              <option value="solid">solid</option>
              <option value="glow">glow</option>
              <option value="gradient">gradient</option>
            </select>
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label>Disc / Cover size</label>
            <div class="row">
              <input id="disc" type="range" min="120" max="360" step="2" value="200" oninput="discOut.textContent=this.value"/>
              <div class="range-display"><span id="discOut">200</span>px</div>
            </div>
          </div>
          <div>
            <label>Progress height</label>
            <div class="row">
              <input id="bar" type="range" min="0" max="16" step="1" value="6" oninput="barOut.textContent=this.value"/>
              <div class="range-display"><span id="barOut">6</span>px</div>
            </div>
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label>Progress width</label>
            <div class="row">
              <input id="progressWidth" type="range" min="50" max="100" step="5" value="100" oninput="progWidthOut.textContent=this.value"/>
              <div class="range-display"><span id="progWidthOut">100</span>%</div>
            </div>
          </div>
          <div>
            <label>Text alignment</label>
            <select id="textAlign">
              <option value="auto">Auto (follows media)</option>
              <option value="left">Left</option>
              <option value="center">Center</option>
              <option value="right">Right</option>
            </select>
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label>Corner radius</label>
            <div class="row">
              <input id="radius" type="range" min="0" max="24" step="1" value="16" oninput="radOut.textContent=this.value"/>
              <div class="range-display"><span id="radOut">16</span>px</div>
            </div>
          </div>
          <div>
            <label>Blur</label>
            <div class="row">
              <input id="blur" type="range" min="0" max="16" step="1" value="8" oninput="blurOut.textContent=this.value"/>
              <div class="range-display"><span id="blurOut">8</span>px</div>
            </div>
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label>Safe padding</label>
            <div class="row">
              <input id="pad" type="range" min="0" max="32" step="1" value="16" oninput="padOut.textContent=this.value"/>
              <div class="range-display"><span id="padOut">16</span>px</div>
            </div>
          </div>
          <div>
            <label>Title outline</label>
            <div class="row">
              <input id="outline" type="range" min="0" max="2" step="1" value="0" oninput="outlineOut.textContent=this.value"/>
              <div class="range-display"><span id="outlineOut">0</span>px</div>
            </div>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="check"><input id="compact" type="checkbox" class="sw"/><label for="compact">Compact spacing</label></div>
          <div class="check"><input id="spin" type="checkbox" class="sw" checked/><label for="spin">Spin while playing</label></div>
        </div>
        <div class="grid cols-2">
          <div class="check"><input id="labelStatic" type="checkbox" class="sw"/><label for="labelStatic">Keep label upright</label></div>
          <div class="check"><input id="tonearm" type="checkbox" class="sw" checked/><label for="tonearm">Show tonearm (record)</label></div>
        </div>
      </div>

      <div class="card section">
        <h3>Elements</h3>
        <div class="grid cols-2">
          <div class="check"><input id="showStatus" type="checkbox" class="sw" checked/><label for="showStatus">Status pill</label></div>
          <div class="check"><input id="showProgress" type="checkbox" class="sw" checked/><label for="showProgress">Progress bar</label></div>
        </div>
        <div class="grid cols-2">
          <div class="check"><input id="showTime" type="checkbox" class="sw" checked/><label for="showTime">Time (elapsed/total)</label></div>
          <div class="check"><input id="showTitle" type="checkbox" class="sw" checked/><label for="showTitle">Title</label></div>
        </div>
        <div class="grid cols-2">
          <div class="check"><input id="showArtist" type="checkbox" class="sw" checked/><label for="showArtist">Artist</label></div>
          <div class="check"><input id="showNext" type="checkbox" class="sw"/><label for="showNext">Show Next (stacked)</label></div>
        </div>
      </div>

      <div class="card section">
        <h3>Text & Motion</h3>
        <div class="grid cols-2">
          <div class="check"><input id="scroll" type="checkbox" class="sw" checked/><label for="scroll">Scroll long text</label></div>
          <div class="check"><input id="autoAccent" type="checkbox" class="sw"/><label for="autoAccent">Auto-accent from album art</label></div>
        </div>
        <div class="grid cols-2">
          <div>
            <label>Marquee speed</label>
            <div class="row">
              <input id="marq" type="range" min="8" max="30" step="1" value="18" oninput="marqOut.textContent=this.value"/>
              <div class="range-display"><span id="marqOut">18</span>s</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card section">
        <h3>Colors & Fonts</h3>
        <div class="grid cols-2">
          <div>
            <label>Color mode</label>
            <select id="colorMode">
              <option value="theme">Theme</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div>
            <label>Shadow</label>
            <select id="shadow">
              <option value="1">on</option>
              <option value="0">off</option>
            </select>
          </div>
        </div>
        <div id="colorsBlock" class="grid">
          <div class="color-row">
            <label style="min-width:120px">Accent</label>
            <input id="accent" type="color" value="#1db954"/>
            <label>Text</label>
            <input id="text" type="color" value="#eaeaea"/>
            <label>Muted</label>
            <input id="muted" type="color" value="#b6bcc4"/>
          </div>
          <div class="grid cols-2">
            <div>
              <label>Font</label>
              <select id="font">
                <option value="">(default)</option>
                <option>inter</option><option>rubik</option><option>montserrat</option><option>poppins</option><option>firasans</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="card section">
        <h3>Background</h3>
        <div class="grid cols-2">
          <div class="check"><input id="transparent" type="checkbox" class="sw"/><label for="transparent">Transparent panel</label></div>
          <div>
            <label>Panel opacity</label>
            <div class="row">
              <input id="panelAlpha" type="range" min="0" max="100" step="1" value="72" oninput="paOut.textContent=this.value"/>
              <div class="range-display"><span id="paOut">72</span>%</div>
            </div>
          </div>
          <div>
            <label>Panel color</label>
            <div class="color-row">
              <input id="panelColor" type="color" value="#121212"/>
            </div>
          </div>
        </div>
      </div>

      <div class="card section">
        <h3>Preview & Presets</h3>
        <div class="grid cols-2">
          <div class="check"><input id="demo" type="checkbox" class="sw" checked/><label for="demo">Use demo data in preview</label></div>
          <button id="transparentPreset" class="btn ghost">1-click Transparent</button>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="card preview-bar">
        <div><div style="font-weight:700; font-size: 16px;">Live Preview</div><div class="badge">Turn off "demo" to login inside the preview</div></div>
        <div class="badge">Resize to test scaling</div>
      </div>
      <div class="card preview-wrap">
        <iframe id="preview" src="" allow="clipboard-read; clipboard-write"></iframe>
      </div>
    </div>
  </div>

<script>
  const $ = id => document.getElementById(id);
  const els = {
    base:$('base'), layout:$('layout'), align:$('align'), theme:$('theme'), accentstyle:$('accentstyle'),
    disc:$('disc'), bar:$('bar'), radius:$('radius'), blur:$('blur'), pad:$('pad'), outline:$('outline'),
    compact:$('compact'), spin:$('spin'), labelStatic:$('labelStatic'), tonearm:$('tonearm'),
    showStatus:$('showStatus'), showProgress:$('showProgress'), showTime:$('showTime'), showTitle:$('showTitle'), showArtist:$('showArtist'), showNext:$('showNext'),
    scroll:$('scroll'), marq:$('marq'), autoAccent:$('autoAccent'),
    colorMode:$('colorMode'), accent:$('accent'), text:$('text'), muted:$('muted'), font:$('font'), shadow:$('shadow'),
    transparent:$('transparent'), panelColor:$('panelColor'), panelAlpha:$('panelAlpha'),
    progressWidth:$('progressWidth'), textAlign:$('textAlign'),
    demo:$('demo'), transparentPreset:$('transparentPreset'),
    url:$('url'), copy:$('copy'), open:$('open'), reset:$('reset'), preview:$('preview'),
    colorsBlock:$('colorsBlock')
  };

  function toggleColorsBlock(){
    const custom = els.colorMode.value === 'custom';
    els.colorsBlock.classList.toggle('muted', !custom);
  }

  // Presets (unchanged logic; now respect colorMode=theme)
  document.querySelectorAll('[data-preset]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const p = btn.dataset.preset;
      if(p==='record'){ setState({layout:'record',align:'left',theme:'spotify',accentstyle:'solid',disc:200,bar:6,radius:16,blur:8,pad:16,outline:0,compact:0,spin:1,labelStatic:0,tonearm:1,showStatus:1,showProgress:1,showTime:1,showTitle:1,showArtist:1,showNext:0,scroll:1,marq:18,autoAccent:0,colorMode:'theme',transparent:0,panelColor:'#121212',panelAlpha:72,progressWidth:100,textAlign:'auto'}); }
      if(p==='card'){ setState({layout:'card',align:'left',theme:'obsdark',accentstyle:'solid',disc:220,bar:6,radius:14,blur:6,pad:16,outline:0,compact:0,spin:1,labelStatic:0,tonearm:0,showStatus:1,showProgress:1,showTime:1,showTitle:1,showArtist:1,showNext:0,scroll:1,marq:16,autoAccent:0,colorMode:'theme',transparent:0,panelColor:'#18181b',panelAlpha:72,progressWidth:100,textAlign:'auto'}); }
      if(p==='bar'){ setState({layout:'bar',align:'left',theme:'minimal',accentstyle:'solid',disc:200,bar:4,radius:12,blur:2,pad:10,outline:0,compact:1,spin:1,labelStatic:0,tonearm:0,showStatus:0,showProgress:1,showTime:0,showTitle:1,showArtist:1,showNext:0,scroll:1,marq:14,autoAccent:0,colorMode:'theme',transparent:1,progressWidth:100,textAlign:'auto'}); }
      if(p==='stacked'){ setState({layout:'stacked',align:'left',theme:'oldradio',accentstyle:'glow',disc:220,bar:6,radius:12,blur:3,pad:16,outline:0,compact:0,spin:1,labelStatic:0,tonearm:1,showStatus:1,showProgress:1,showTime:1,showTitle:1,showArtist:1,showNext:1,scroll:1,marq:18,autoAccent:0,colorMode:'theme',transparent:0,progressWidth:100,textAlign:'center'}); }
      if(p==='transparent'){ setState({layout:'record',align:'left',theme:'spotify',accentstyle:'glow',disc:180,bar:4,radius:0,blur:0,pad:0,outline:1,compact:1,spin:1,labelStatic:1,tonearm:1,showStatus:0,showProgress:1,showTime:0,showTitle:1,showArtist:1,showNext:0,scroll:1,marq:16,autoAccent:0,colorMode:'theme',transparent:1,progressWidth:100,textAlign:'auto'}); }
    });
  });

  function setState(s){
    for(const k in s){
      if(els[k] && 'value' in els[k]) els[k].value = s[k];
      if(els[k] && 'checked' in els[k]) els[k].checked = !!s[k];
    }
    toggleColorsBlock(); render();
  }

  const KEY='spotistream_builder_v32';
  function saveState(){ localStorage.setItem(KEY, JSON.stringify(getState())); }
  function loadState(){ try{ const s=JSON.parse(localStorage.getItem(KEY)||'{}'); setState(s); }catch(e){} }

  function hexToRgb(hex){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)||[]; return {r:parseInt(m[1]||'00',16), g:parseInt(m[2]||'00',16), b:parseInt(m[3]||'00',16)}; }

  function getState(){
    return {
      base:els.base.value.trim(),
      layout:els.layout.value, align:els.align.value, theme:els.theme.value, accentstyle:els.accentstyle.value,
      disc:els.disc.value, bar:els.bar.value, radius:els.radius.value, blur:els.blur.value, pad:els.pad.value, outline:els.outline.value,
      compact:+els.compact.checked, spin:+els.spin.checked, labelStatic:+els.labelStatic.checked, tonearm:+els.tonearm.checked,
      showStatus:+els.showStatus.checked, showProgress:+els.showProgress.checked, showTime:+els.showTime.checked, showTitle:+els.showTitle.checked, showArtist:+els.showArtist.checked, showNext:+els.showNext.checked,
      scroll:+els.scroll.checked, marq:els.marq.value, autoAccent:+els.autoAccent.checked,
      colorMode:els.colorMode.value, accent:els.accent.value, text:els.text.value, muted:els.muted.value, font:els.font.value, shadow:els.shadow.value,
      transparent:+els.transparent.checked, panelColor:els.panelColor.value, panelAlpha:els.panelAlpha.value,
      progressWidth:els.progressWidth.value, textAlign:els.textAlign.value,
      demo:+els.demo.checked
    };
  }

  function buildURL(){
    const s=getState(); if(!s.base) return '';
    const q=new URLSearchParams();

    if(s.layout && s.layout!=='record') q.set('layout', s.layout);
    if(s.align && s.align!=='left') q.set('align', s.align);
    if(s.theme) q.set('theme', s.theme);
    if(s.accentstyle && s.accentstyle!=='solid') q.set('accentstyle', s.accentstyle);

    // sizes & visuals
    if(s.disc) q.set('disc', s.disc);
    if(s.bar) q.set('bar', s.bar);
    if(s.radius) q.set('radius', s.radius);
    if(s.blur) q.set('blur', s.blur);
    if(s.pad) q.set('pad', s.pad);
    if(s.outline) q.set('outline', s.outline);
    if(s.marq && s.marq!=='18') q.set('marq', s.marq);

    // toggles
    if(s.compact) q.set('compact','1');
    if(!s.spin) q.set('spin','0');
    if(s.labelStatic) q.set('label','static');
    if(!s.tonearm) q.set('tonearm','0');

    // elements
    if(!s.showStatus) q.set('showstatus','0');
    if(!s.showProgress) q.set('showprogress','0');
    if(!s.showTime) q.set('showtime','0');
    if(!s.showTitle) q.set('title','0');
    if(!s.showArtist) q.set('artist','0');
    if(s.showNext) q.set('next','1');

    // text & motion
    if(!s.scroll) q.set('scroll','0');
    if(s.autoAccent) q.set('autoaccent','1'); // default OFF

    // progress & text alignment
    if(s.progressWidth && s.progressWidth!=='100') q.set('progresswidth', s.progressWidth);
    if(s.textAlign && s.textAlign!=='auto') q.set('textalign', s.textAlign);

    // colors/fonts
    if(s.colorMode==='custom'){ // only send when user really wants custom colors
      if(s.accent) q.set('accent', s.accent);
      if(s.text)   q.set('text', s.text);
      if(s.muted)  q.set('muted', s.muted);
    }
    if(s.font) q.set('font', s.font);
    if(s.shadow==='0') q.set('shadow','0');

    // background
    if(s.transparent){ q.set('transparent','1'); }
    else {
      const {r,g,b}=hexToRgb(s.panelColor); const a=Math.max(0,Math.min(100,parseInt(s.panelAlpha||'72',10)))/100;
      q.set('panel', `rgba(${r},${g},${b},${a})`);
    }


    const sep = s.base.includes('?') ? '&' : '?';
    return s.base + (q.toString() ? sep + q.toString() : '');
  }

  function render(){
    els.showNext.disabled = (els.layout.value!=='stacked');
    toggleColorsBlock();
    const u=buildURL(); els.url.textContent=u; els.preview.src=u; saveState();
  }

  function wire(){
    for(const k in els){
      const n=els[k]; if(!n) continue;
      if(n.tagName==='INPUT' || n.tagName==='SELECT'){ n.addEventListener('input', render); n.addEventListener('change', render); }
    }
    els.colorMode.addEventListener('change', toggleColorsBlock);
    $('copy').onclick=async()=>{ try{ await navigator.clipboard.writeText(els.url.textContent); $('copy').textContent='Copied!'; setTimeout(()=>$('copy').textContent='Copy URL',1200);}catch(e){} };
    $('open').onclick=()=>{ if(els.url.textContent) window.open(els.url.textContent,'_blank'); };
    $('reset').onclick=()=>{ localStorage.removeItem(KEY); location.reload(); };
    $('transparentPreset').onclick=()=>{ els.transparent.checked=true; els.blur.value=0; els.radius.value=0; els.pad.value=0; els.shadow.value='0'; render(); };
  }

  wire(); loadState(); if(!els.url.textContent) render();
</script>
</body>
</html>
