<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SpotiStream – Spotify Now Playing</title>
<style>
  :root{
    /* Visual tokens */
    --bg: rgba(0,0,0,0);                 /* overall background (keep transparent for stream) */
    --panel: rgba(18,18,18,0.72);        /* panel glass */
    --text: #eaeaea;
    --muted:#b6bcc4;
    --accent:#1db954;
    --shadow: 0 12px 36px rgba(0,0,0,0.35);

    /* Sizing */
    --radius: 16px;
    --blur: 8px;
    --disc: 200px;                       /* default disc/cover size */
    --bar-h: 6px;
    --gutter: 16px;

    /* Type */
    --font: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    --title-size: clamp(18px, 2.6vw, 22px);
    --artist-size: clamp(12px, 1.8vw, 14px);
  }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font: 500 14px/1.45 var(--font);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    overflow:hidden;
  }

  /* ===== Container (never clips UI; nice shadow; responsive) ===== */
  .wrap{
    width:100%; height:100%;
    box-sizing:border-box;
    padding: var(--gutter);
    display:grid; gap: var(--gutter);
    align-items:center;
    backdrop-filter: blur(var(--blur)) saturate(120%);
    background: var(--panel);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  /* ===== Layouts ===== */
  /* Record: disc left, meta right (default) */
  .layout-record.wrap{
    grid-template-columns: var(--disc) 1fr;
    grid-template-areas: "disc meta";
  }

  /* Card: rectangular art + meta */
  .layout-card.wrap{
    grid-template-columns: var(--disc) 1fr;
    grid-template-areas: "art meta";
  }

  /* Bar: text-only strip */
  .layout-bar.wrap{
    grid-template-columns: 1fr;
    grid-template-areas: "meta";
    padding: 12px 16px;
  }
  .layout-bar .pill, .layout-bar .disc, .layout-bar .artbox { display:none }

  /* Stacked: disc top, meta below */
  .layout-stacked.wrap{
    grid-template-columns: 1fr;
    grid-template-areas: "disc" "meta";
    justify-items:center;
    text-align:center;
  }
  .layout-stacked .meta{ width:min(560px, 100%) }
  .layout-stacked .time{ justify-content:center; gap:16px }

  /* ===== Disc (vinyl) ===== */
  .disc{ grid-area:disc; position:relative; width:var(--disc); height:var(--disc); border-radius:50%;
    background:
      radial-gradient(circle at 50% 50%, rgba(255,255,255,0.07) 0 6%, transparent 6%),
      repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,0.08) 0 1px, transparent 2px 6px),
      #0f0f0f;
    box-shadow: inset 0 0 30px rgba(0,0,0,0.7), 0 12px 30px rgba(0,0,0,0.4);
    display:grid; place-items:center; overflow:hidden;
  }
  /* rotating highlights */
  .disc::before{ content:""; position:absolute; inset:-18%;
    background:
      radial-gradient(circle at 18% 22%, rgba(255,255,255,0.08), transparent 50%),
      radial-gradient(circle at 80% 78%, rgba(255,255,255,0.06), transparent 50%);
    border-radius:50%; z-index:1;
    animation: sheen 9s linear infinite;
  }
  @keyframes sheen{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

  /* Center label uses CSS background to avoid alt-text leaks */
  .label-img{ width:62%; height:62%; border-radius:50%; background:#222 center/cover no-repeat;
    box-shadow: 0 2px 10px rgba(0,0,0,0.35); position:relative; z-index:2;
  }
  /* Center hole */
  .disc::after{ content:""; position:absolute; width:8px; height:8px; border-radius:50%;
    background:#000; box-shadow: 0 0 0 1px rgba(255,255,255,0.28); z-index:3;
  }
  /* Spin only when allowed */
  .spin .label-img, .spin::before{ animation: spin 9s linear infinite }
  @keyframes spin{ from{transform:rotate(0deg)} to{transform:rotate(360deg)} }

  /* Decorative tonearm (hidden on small or non-record layouts) */
  .tonearm{ position:absolute; right:-26px; top:14px; width:136px; height:26px;
    transform:rotate(21deg); transform-origin:left center; pointer-events:none;
    filter: drop-shadow(0 2px 8px rgba(0,0,0,0.5));
  }
  .tonearm .arm{ position:absolute; left:0; top:10px; width:116px; height:6px; background:linear-gradient(#cfcfcf,#969696); border-radius:4px }
  .tonearm .head{ position:absolute; right:0; top:6px; width:22px; height:14px; background:linear-gradient(#666,#333); border-radius:3px }
  .tonearm .joint{ position:absolute; left:-8px; top:6px; width:14px; height:14px; border-radius:50%; background:#a7a7a7; box-shadow: inset 0 1px 2px rgba(0,0,0,0.45) }

  /* Rectangular art for card layout */
  .artbox{ grid-area:art; width:var(--disc); height:var(--disc); border-radius:12px; overflow:hidden;
    background:#222 center/cover no-repeat; box-shadow: 0 10px 30px rgba(0,0,0,0.38);
  }

  /* ===== Meta / text / progress ===== */
  .meta{ grid-area:meta; min-width:0; display:grid; gap:10px; align-content:center }
  .title{
    font-size:var(--title-size); font-weight:800; letter-spacing:0.2px;
    white-space:nowrap; overflow:hidden;
    -webkit-mask-image: linear-gradient(90deg, #000 90%, transparent 100%);
            mask-image: linear-gradient(90deg, #000 90%, transparent 100%);
  }
  .artist{
    font-size:var(--artist-size); color:var(--muted);
    white-space:nowrap; overflow:hidden;
    -webkit-mask-image: linear-gradient(90deg, #000 92%, transparent 100%);
            mask-image: linear-gradient(90deg, #000 92%, transparent 100%);
  }
  .row{ display:flex; align-items:center; gap:8px }
  .pill{ display:inline-flex; align-items:center; gap:8px; background: rgba(255,255,255,0.08); padding:6px 10px; border-radius:999px }
  .dot{ width:6px; height:6px; border-radius:999px; background:var(--accent); box-shadow:0 0 8px var(--accent) }

  .progress{ height:var(--bar-h); border-radius:999px; position:relative; overflow:hidden; background: rgba(255,255,255,0.18) }
  .bar{ position:absolute; inset:0 100% 0 0; background: var(--accent); border-radius:999px }
  .time{ display:flex; justify-content:space-between; font-variant-numeric:tabular-nums; color:var(--muted) }

  .btn{ appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer; background:var(--accent); color:#000; box-shadow: var(--shadow) }
  .setup{ display:grid; gap:12px }
  .field{ display:grid; gap:6px }
  .input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color:var(--text) }
  .hidden{ display:none !important }

  /* Compact spacing (any layout) */
  .compact.wrap{ padding:10px 12px; gap:12px }
  .compact .title{ --title-size: clamp(16px,2.1vw,20px) }
  .compact .artist{ --artist-size: clamp(11px,1.6vw,13px) }

  /* Small widths: prevent crowding automatically */
  @media (max-width: 540px){
    :root{ --disc: 150px }
    .tonearm{ display:none }
  }
</style>
</head>
<body>
  <div id="root" class="layout-record">
    <div id="card" class="wrap">
      <!-- Disc (default) -->
      <div id="disc" class="disc spin">
        <div id="labelImg" class="label-img"></div>
        <div id="tonearm" class="tonearm"><div class="arm"></div><div class="head"></div><div class="joint"></div></div>
      </div>

      <!-- Card layout art -->
      <div id="artbox" class="artbox hidden"></div>

      <!-- Meta -->
      <div class="meta">
        <div class="row"><div class="pill"><span class="dot"></span><span id="status">Paused</span></div></div>
        <div id="title" class="title">Nothing playing</div>
        <div id="artist" class="artist">—</div>

        <div class="progress" title="Progress"><div id="bar" class="bar"></div></div>
        <div class="time"><div id="elapsed">0:00</div><div id="duration">0:00</div></div>

        <div id="setup" class="setup hidden">
          <div class="field"><label for="clientId">Spotify Client ID</label><input id="clientId" class="input" placeholder="paste your Client ID"/></div>
          <button id="save" class="btn">Save Client ID</button>
          <button id="connect" class="btn">Connect to Spotify</button>
          <small class="artist">In your Spotify app, the Redirect URI must exactly match this page URL (ending with <code>/overlay.html</code>).</small>
        </div>
      </div>
    </div>
  </div>

<script>
  /* ==========================
     Distinct Themes
     ========================== */
  const THEMES = {
    spotify:  { panel:'rgba(18,18,18,0.72)', text:'#eaeaea', muted:'#b6bcc4', accent:'#1db954', radius:16, blur:8 },
    obsdark:  { panel:'rgba(24,24,27,0.72)', text:'#e6e7ea', muted:'#9da3ad', accent:'#22d3ee', radius:14, blur:6 },
    minimal:  { panel:'rgba(0,0,0,0.34)',   text:'#ffffff', muted:'#cfcfcf', accent:'#ffffff', radius:12, blur:2, bar:4, shadow:0 },
    neon:     { panel:'rgba(8,10,22,0.62)', text:'#e9f0ff', muted:'#9ab0ff', accent:'#7cf4ff', radius:14, blur:10 },
    oldradio: { panel:'rgba(64,50,34,0.62)',text:'#fff7e6', muted:'#eed9b7', accent:'#ffb84d', radius:12, blur:3, bar:4 },
    blue:     { panel:'rgba(10,24,48,0.55)',text:'#e6f0ff', muted:'#a9c1ff', accent:'#4da3ff', radius:16, blur:8 },
    red:      { panel:'rgba(48,12,18,0.52)',text:'#ffeaea', muted:'#ffb3b3', accent:'#ff4d4d', radius:16, blur:8 },
    yellow:   { panel:'rgba(48,40,12,0.52)',text:'#fff9db', muted:'#ffe7a3', accent:'#ffd43b', radius:16, blur:8 },
    slate:    { panel:'rgba(0,0,0,0.55)',   text:'#ffffff', muted:'#c7c7c7', accent:'#1db954', radius:16, blur:6 }
  };

  const FONT_URLS = {
    inter: 'https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap',
    rubik: 'https://fonts.googleapis.com/css2?family=Rubik:wght@600;800&display=swap',
    montserrat: 'https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap',
    poppins: 'https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&display=swap',
    firasans: 'https://fonts.googleapis.com/css2?family=Fira+Sans:wght@600;800&display=swap'
  };

  function applyVars(obj){
    const r = document.documentElement.style;
    if (obj.panel) r.setProperty('--panel', obj.panel);
    if (obj.text)  r.setProperty('--text', obj.text);
    if (obj.muted) r.setProperty('--muted', obj.muted);
    if (obj.accent)r.setProperty('--accent', obj.accent);
    if (obj.radius!=null) r.setProperty('--radius', obj.radius+'px');
    if (obj.blur!=null)   r.setProperty('--blur',   obj.blur+'px');
    if (obj.bar!=null)    r.setProperty('--bar-h',  obj.bar+'px');
    if (obj.shadow===0)   r.setProperty('--shadow','none');
  }

  function applyFont(name){
    if (!name) return;
    const key = name.toLowerCase();
    const href = FONT_URLS[key];
    if (href){
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = href;
      document.head.appendChild(link);
      const fam = {inter:'"Inter"', rubik:'"Rubik"', montserrat:'"Montserrat"', poppins:'"Poppins"', firasans:'"Fira Sans"'}[key];
      if (fam) document.documentElement.style.setProperty('--font', `${fam}, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`);
    }
  }

  /* ==========================
     URL Controls (layout/theme/knobs)
     ========================== */
  const p = new URLSearchParams(location.search);
  const layout = (p.get('layout') || 'record').toLowerCase();
  const root = document.getElementById('root');
  root.className = `layout-${layout}`;

  // For non-record layouts, hide tonearm + disc or art appropriately
  const discEl = document.getElementById('disc');
  const artbox = document.getElementById('artbox');
  const tonearm = document.getElementById('tonearm');
  if (layout === 'card'){ discEl.style.display='none'; artbox.classList.remove('hidden'); }
  if (layout !== 'record'){ tonearm.style.display='none'; }

  const themeKey = (p.get('theme') || 'spotify').toLowerCase();
  if (THEMES[themeKey]) applyVars(THEMES[themeKey]);

  // Fine-grained overrides
  const map = { accent:'--accent', panel:'--panel', text:'--text', muted:'--muted' };
  for (const [k,css] of Object.entries(map)){ const v=p.get(k); if (v) document.documentElement.style.setProperty(css, v); }
  if (p.get('radius')) document.documentElement.style.setProperty('--radius', p.get('radius')+'px');
  if (p.get('blur'))   document.documentElement.style.setProperty('--blur',   p.get('blur')+'px');
  if (p.get('bar'))    document.documentElement.style.setProperty('--bar-h',  p.get('bar')+'px');
  if (p.get('shadow')==='0') document.documentElement.style.setProperty('--shadow','none');

  if (p.get('compact')==='1') document.getElementById('card').classList.add('compact');
  window.__forceSpin = p.get('spin'); // '0' to stop spinning
  applyFont(p.get('font'));

  /* ==========================
     Spotify Logic
     ========================== */
  const SCOPES = ['user-read-playback-state','user-read-currently-playing'];
  const TOKEN_URL = 'https://accounts.spotify.com/api/token';
  const AUTH_URL  = 'https://accounts.spotify.com/authorize';
  const REDIRECT_URI = window.location.origin + window.location.pathname;

  const el = id=>document.getElementById(id);
  const titleEl=el('title'), artistEl=el('artist'), statusEl=el('status'),
        barEl=el('bar'), elapsedEl=el('elapsed'), durationEl=el('duration'),
        labelDiv = el('labelImg');

  let accessToken=null, refreshToken=null, expiresAt=0;
  let playing=false, progressMs=0, durationMs=0;

  const K = { clientId:'obs_spotify_client_id', verifier:'obs_spotify_code_verifier', access:'obs_spotify_access_token', refresh:'obs_spotify_refresh_token', expires:'obs_spotify_expires_at' };

  async function sha256(str){ const buf=new TextEncoder().encode(str); const d=await crypto.subtle.digest('SHA-256', buf); return new Uint8Array(d); }
  function base64url(bytes){ return btoa(String.fromCharCode(...bytes)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
  function randString(len=64){ const a=new Uint8Array(len); crypto.getRandomValues(a); return base64url(a).slice(0,len); }

  function msToClock(ms){ ms=Math.max(0,Math.floor(ms)); const t=Math.floor(ms/1000); const m=Math.floor(t/60); const s=t%60; return `${m}:${s.toString().padStart(2,'0')}`; }
  function setProgress(p){ const c=Math.max(0,Math.min(1,p)); barEl.style.inset = `0 ${(1-c)*100}% 0 0`; elapsedEl.textContent=msToClock(progressMs); durationEl.textContent=msToClock(durationMs); }
  function setStatus(t){ statusEl.textContent=t; }
  function showSetup(b){ document.getElementById('setup').classList.toggle('hidden', !b); }

  function loadStored(){ accessToken=localStorage.getItem(K.access); refreshToken=localStorage.getItem(K.refresh); expiresAt=parseInt(localStorage.getItem(K.expires)||'0',10); return !!accessToken; }
  function saveTokens(a,r,e){ if(a){accessToken=a;localStorage.setItem(K.access,a);} if(r){refreshToken=r;localStorage.setItem(K.refresh,r);} if(e){expiresAt=Date.now()+e*1000-10000; localStorage.setItem(K.expires,String(expiresAt));} }

  async function fetchJSON(url,opts={}){ const res=await fetch(url,opts); if(res.status===204) return null; if(!res.ok) throw new Error(`HTTP ${res.status}`); return await res.json(); }

  async function refresh(){
    const cid=localStorage.getItem(K.clientId); if(!refreshToken||!cid) return;
    const body=new URLSearchParams({client_id:cid,grant_type:'refresh_token',refresh_token:refreshToken});
    try{ const tok=await fetchJSON(TOKEN_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
         saveTokens(tok.access_token, tok.refresh_token||refreshToken, tok.expires_in);
    }catch(e){ console.error('Refresh failed', e); setStatus('Refresh failed'); }
  }

  async function ensureToken(){
    const cid=localStorage.getItem(K.clientId);
    if(!cid){ showSetup(true); setStatus('Setup required'); return false; }
    const url=new URL(window.location.href);
    const code=url.searchParams.get('code'); const err=url.searchParams.get('error');
    if(err){ showSetup(true); setStatus('Auth error'); console.error('Spotify auth error:',err); return false; }
    if(code){
      const verifier=localStorage.getItem(K.verifier);
      try{
        const body=new URLSearchParams({client_id:cid,grant_type:'authorization_code',code,redirect_uri:REDIRECT_URI,code_verifier:verifier});
        const tok=await fetchJSON(TOKEN_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
        saveTokens(tok.access_token, tok.refresh_token, tok.expires_in);
        history.replaceState({},'',REDIRECT_URI);
      }catch(e){ console.error(e); showSetup(true); setStatus('Token exchange failed'); return false; }
    }
    loadStored();
    if(!accessToken){ if(refreshToken){ await refresh(); } else { showSetup(true); setStatus('Not connected'); return false; } }
    if(Date.now()>expiresAt) await refresh();
    return true;
  }

  async function getCurrentlyPlaying(){
    const ok=await ensureToken(); if(!ok||!accessToken) return null;
    try{ return await fetchJSON('https://api.spotify.com/v1/me/player/currently-playing',{ headers:{ Authorization:`Bearer ${accessToken}` } }); }
    catch(e){ if(String(e).includes('401')) await refresh(); return null; }
  }

  function renderNothing(){
    playing=false;
    titleEl.textContent='Nothing playing';
    artistEl.textContent='—';
    setStatus('Paused');
    durationMs=progressMs=0; setProgress(0);
    document.getElementById('disc').classList.remove('spin');
    labelDiv.style.backgroundImage = '';
    artbox.style.backgroundImage = '';
  }

  function renderTrack(payload){
    const item=payload?.item;
    if(!item){ renderNothing(); return; }

    const img = (item.album?.images?.[0]?.url)||'';
    if (img){
      labelDiv.style.backgroundImage = `url('${img}')`;
      artbox.style.backgroundImage   = `url('${img}')`;
    }

    const artists=(item.artists||[]).map(a=>a.name).join(', ');
    titleEl.textContent = item.name || 'Untitled';
    artistEl.textContent = artists || 'Unknown artist';

    playing = !!payload.is_playing;
    setStatus(playing?'Playing':'Paused');

    const spinFlag = window.__forceSpin;
    const allowSpin = !(spinFlag==='0');
    document.getElementById('disc').classList.toggle('spin', playing && allowSpin);

    durationMs=item.duration_ms||0;
    progressMs=payload.progress_ms||0;
    setProgress(durationMs?progressMs/durationMs:0);
  }

  function initSetup(){
    const clientIdInput = document.getElementById('clientId');
    const saveBtn = document.getElementById('save');
    const connectBtn = document.getElementById('connect');

    clientIdInput.value = localStorage.getItem(K.clientId)||'';
    saveBtn.onclick = () => {
      const v = clientIdInput.value.trim();
      if(!v) return alert('Please paste your Spotify Client ID');
      localStorage.setItem(K.clientId, v);
      alert('Saved! Now click Connect to Spotify.');
    };
    connectBtn.onclick = async () => {
      const cid = localStorage.getItem(K.clientId);
      if(!cid) return alert('Save your Client ID first.');
      const verifier = (() => {
        const arr = new Uint8Array(64); crypto.getRandomValues(arr);
        return btoa(String.fromCharCode(...arr)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'').slice(0,64);
      })();
      const challenge = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier))
        .then(buf => btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''));
      localStorage.setItem(K.verifier, verifier);

      const a = new URL(AUTH_URL);
      a.searchParams.set('response_type','code');
      a.searchParams.set('client_id', cid);
      a.searchParams.set('redirect_uri', REDIRECT_URI);
      a.searchParams.set('scope', SCOPES.join(' '));
      a.searchParams.set('code_challenge_method','S256');
      a.searchParams.set('code_challenge', challenge);
      window.location.href = a.toString();
    };
  }

  (async function main(){
    initSetup();
    await ensureToken();
    showSetup(!accessToken);

    // Poll + tick
    setInterval(async ()=>{
      const data = await getCurrentlyPlaying();
      if(!data){ renderNothing(); return; }
      renderTrack(data);
    }, 3000);

    // Smooth progress
    setInterval(()=>{
      if(playing && durationMs>0){
        progressMs += 250;
        if(progressMs>durationMs) progressMs=durationMs;
        setProgress(progressMs/durationMs);
      }
    }, 250);
  })();
</script>
</body>
</html>
