<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SpotiStream – Spotify Now Playing</title>
<style>
  :root{
    --bg: rgba(0,0,0,0);
    --panel: rgba(18,18,18,0.72);
    --text: #eaeaea; --muted:#b6bcc4; --accent:#1db954;
    --shadow: 0 12px 36px rgba(0,0,0,0.35);
    --radius: 16px; --blur: 8px;
    --disc: 200px; --bar-h: 6px; --gap: 22px; --max-w: 1100px; --pad:16px;
    --font: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    --title-size: clamp(18px,2.8vw,24px); --artist-size: clamp(12px,2vw,15px);
    --outline: 0px;                      /* text outline thickness */
    --marq-s: 18s;                        /* marquee speed */
    --accent-style: solid;                /* solid|glow|gradient */
  }
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:600 14px/1.45 var(--font); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; overflow:hidden;}

  /* ===== Panel / centering ===== */
  .wrap{width:100%; height:100%; box-sizing:border-box; padding:var(--pad); display:flex; align-items:center; justify-content:center; backdrop-filter: blur(var(--blur)) saturate(120%); background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow);}
  .inner{width:100%; max-width: var(--max-w); display:grid; gap: var(--gap); align-items:center;}

  /* ===== Layouts & alignment ===== */
  .layout-record.left .inner{grid-template-columns: var(--disc) minmax(320px,1fr); grid-template-areas: "disc meta";}
  .layout-record.right .inner{grid-template-columns: minmax(320px,1fr) var(--disc); grid-template-areas: "meta disc";}
  .layout-card.left   .inner{grid-template-columns: var(--disc) minmax(320px,1fr); grid-template-areas: "art meta";}
  .layout-card.right  .inner{grid-template-columns: minmax(320px,1fr) var(--disc); grid-template-areas: "meta art";}
  .layout-bar .inner  {grid-template-columns:1fr; grid-template-areas:"meta"; padding:4px 0;}
  .layout-stacked .inner{grid-template-columns:1fr; grid-template-areas:"disc" "meta"; place-items:center; text-align:center;}

  .layout-bar .pill, .layout-bar .disc, .layout-bar .artbox{display:none}

  .meta{grid-area:meta; min-width:0; display:grid; gap:10px; align-content:center; z-index:2}
  .disc, .artbox{z-index:1}

  /* ===== Disc (vinyl) ===== */
  .disc{grid-area:disc; position:relative; width:var(--disc); height:var(--disc); border-radius:50%; background:
    radial-gradient(circle at 50% 50%, rgba(255,255,255,0.07) 0 6%, transparent 6%),
    repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,0.08) 0 1px, transparent 2px 6px), #0f0f0f;
    box-shadow: inset 0 0 30px rgba(0,0,0,0.7), 0 12px 30px rgba(0,0,0,0.4); display:grid; place-items:center; overflow:hidden;}
  .disc::before{content:""; position:absolute; inset:-18%; background:
    radial-gradient(circle at 18% 22%, rgba(255,255,255,0.08), transparent 50%),
    radial-gradient(circle at 80% 78%, rgba(255,255,255,0.06), transparent 50%); border-radius:50%; z-index:1; animation: sheen 9s linear infinite;}
  @keyframes sheen{from{transform:rotate(0)} to{transform:rotate(360deg)}}
  .label-img{width:62%; height:62%; border-radius:50%; background:#222 center/cover no-repeat; box-shadow:0 2px 10px rgba(0,0,0,0.35); position:relative; z-index:2;}
  .label-static .label-img{animation: spin 9s linear infinite reverse;}
  .disc::after{content:""; position:absolute; width:8px; height:8px; border-radius:50%; background:#000; box-shadow:0 0 0 1px rgba(255,255,255,0.28); z-index:3;}
  .spin .label-img, .spin::before{animation: spin 9s linear infinite}
  @keyframes spin{from{transform:rotate(0)} to{transform:rotate(360deg)}}
  .tonearm{position:absolute; right:-26px; top:14px; width:136px; height:26px; transform:rotate(21deg); transform-origin:left center; pointer-events:none; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.5));}
  .tonearm .arm{position:absolute; left:0; top:10px; width:116px; height:6px; background:linear-gradient(#cfcfcf,#969696); border-radius:4px}
  .tonearm .head{position:absolute; right:0; top:6px; width:22px; height:14px; background:linear-gradient(#666,#333); border-radius:3px}
  .tonearm .joint{position:absolute; left:-8px; top:6px; width:14px; height:14px; border-radius:50%; background:#a7a7a7; box-shadow: inset 0 1px 2px rgba(0,0,0,0.45)}

  /* ===== Card art ===== */
  .artbox{grid-area:art; width:var(--disc); height:var(--disc); border-radius:12px; overflow:hidden; background:#222 center/cover no-repeat; box-shadow: 0 10px 30px rgba(0,0,0,0.38);}

  /* ===== Text + progress ===== */
  .title,.artist{white-space:nowrap; overflow:hidden}
  .title{font-size:var(--title-size); font-weight:800; letter-spacing:0.2px;
    -webkit-mask-image: linear-gradient(90deg,#000 90%,transparent 100%); mask-image: linear-gradient(90deg,#000 90%,transparent 100%);
    text-shadow: 0 0 var(--outline) #000;}
  .artist{font-size:var(--artist-size); color:var(--muted);
    -webkit-mask-image: linear-gradient(90deg,#000 92%,transparent 100%); mask-image: linear-gradient(90deg,#000 92%,transparent 100%);
    text-shadow: 0 0 var(--outline) #000;}
  .row{display:flex; align-items:center; gap:8px}
  .pill{display:inline-flex; align-items:center; gap:8px; background: rgba(255,255,255,0.08); padding:6px 10px; border-radius:999px}
  .dot{width:6px; height:6px; border-radius:999px; background:var(--accent); box-shadow:0 0 8px var(--accent)}
  .progress{height:var(--bar-h); border-radius:999px; position:relative; overflow:hidden; background: rgba(255,255,255,0.18)}
  .bar{position:absolute; inset:0 100% 0 0; border-radius:999px}
  .time{display:flex; justify-content:space-between; font-variant-numeric:tabular-nums; color:var(--muted)}
  .next{font-size:12px; color:var(--muted)}

  /* Accent styles */
  .bar{ background: var(--accent); }
  .accent-glow .dot{ box-shadow: 0 0 12px var(--accent), 0 0 24px var(--accent); }
  .accent-gradient .bar{ background: linear-gradient(90deg, var(--accent), #fff); }

  /* Marquee scrolling */
  .marquee{ position:relative; overflow:hidden; }
  .marquee span{ display:inline-block; padding-right:60px; will-change:transform; animation:marquee var(--marq-s) linear infinite; }
  @keyframes marquee{ from{ transform:translateX(0) } to{ transform:translateX(-50%) } }

  .btn{appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer; background:var(--accent); color:#000; box-shadow: var(--shadow)}
  .setup{display:grid; gap:12px}
  .field{display:grid; gap:6px}
  .input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color:var(--text)}
  .hidden{display:none !important}

  .compact.wrap{padding:10px 12px}
  .compact .inner{gap:14px}
  .compact .title{--title-size: clamp(16px,2.2vw,20px)}
  .compact .artist{--artist-size: clamp(11px,1.7vw,13px)}

  /* Small widths */
  @media (max-width:560px){ :root{--disc:150px} .tonearm{display:none} }

  /* Debug box */
  #debug{position:absolute; bottom:8px; right:8px; background:rgba(0,0,0,0.6); padding:6px 8px; font:12px/1.3 ui-monospace,Consolas,monospace; color:#cfe7ff; border-radius:8px}
</style>
</head>
<body>
  <div id="card" class="wrap">
    <div id="inner" class="inner">
      <div id="disc" class="disc spin">
        <div id="labelImg" class="label-img"></div>
        <div id="tonearm" class="tonearm"><div class="arm"></div><div class="head"></div><div class="joint"></div></div>
      </div>
      <div id="artbox" class="artbox hidden"></div>
      <div class="meta">
        <div id="statusRow" class="row"><div class="pill"><span class="dot"></span><span id="status">Paused</span></div></div>
        <div id="title" class="title">Nothing playing</div>
        <div id="artist" class="artist">—</div>
        <div id="progress" class="progress" title="Progress"><div id="bar" class="bar"></div></div>
        <div id="timeRow" class="time"><div id="elapsed">0:00</div><div id="duration">0:00</div></div>
        <div id="nextRow" class="next hidden"></div>
        <div id="setup" class="setup hidden">
          <div class="field"><label for="clientId">Spotify Client ID</label><input id="clientId" class="input" placeholder="paste your Client ID"/></div>
          <button id="save" class="btn">Save Client ID</button>
          <button id="connect" class="btn">Connect to Spotify</button>
          <small class="artist">Redirect URI must exactly match this page URL (ends with <code>/overlay.html</code>).</small>
        </div>
      </div>
    </div>
  </div>

<script>
  /* ---------------- helpers ---------------- */
  const p = new URLSearchParams(location.search);
  const $ = id => document.getElementById(id);
  const rootStyle = document.documentElement.style;
  const inner = $('inner'), wrap = $('card'), discEl = $('disc'), artbox = $('artbox'), tonearm = $('tonearm'), nextRow = $('nextRow');

  const THEMES = {
    spotify:{panel:'rgba(18,18,18,0.72)',text:'#eaeaea',muted:'#b6bcc4',accent:'#1db954',radius:16,blur:8},
    obsdark:{panel:'rgba(24,24,27,0.72)',text:'#e6e7ea',muted:'#9da3ad',accent:'#22d3ee',radius:14,blur:6},
    minimal:{panel:'rgba(0,0,0,0.34)',text:'#ffffff',muted:'#cfcfcf',accent:'#ffffff',radius:12,blur:2,bar:4,shadow:0},
    neon:{panel:'rgba(8,10,22,0.62)',text:'#e9f0ff',muted:'#9ab0ff',accent:'#7cf4ff',radius:14,blur:10},
    oldradio:{panel:'rgba(64,50,34,0.62)',text:'#fff7e6',muted:'#eed9b7',accent:'#ffb84d',radius:12,blur:3,bar:4},
    blue:{panel:'rgba(10,24,48,0.55)',text:'#e6f0ff',muted:'#a9c1ff',accent:'#4da3ff',radius:16,blur:8},
    red:{panel:'rgba(48,12,18,0.52)',text:'#ffeaea',muted:'#ffb3b3',accent:'#ff4d4d',radius:16,blur:8},
    yellow:{panel:'rgba(48,40,12,0.52)',text:'#fff9db',muted:'#ffe7a3',accent:'#ffd43b',radius:16,blur:8},
    slate:{panel:'rgba(0,0,0,0.55)',text:'#ffffff',muted:'#c7c7c7',accent:'#1db954',radius:16,blur:6},
    twitch:{panel:'rgba(16,12,26,0.66)',text:'#ede9fe',muted:'#c4b5fd',accent:'#9146FF',radius:16,blur:8},
    ytred:{panel:'rgba(26,8,8,0.66)',text:'#ffecec',muted:'#ffb4b4',accent:'#FF0033',radius:16,blur:8},
    aqua:{panel:'rgba(10,24,24,0.55)',text:'#e6fffb',muted:'#a8fff2',accent:'#12d6c5',radius:16,blur:8},
    cyber:{panel:'rgba(6,8,18,0.62)',text:'#d9f2ff',muted:'#8dd6ff',accent:'#00ffe1',radius:16,blur:10},
    pastel:{panel:'rgba(28,25,23,0.45)',text:'#fff7ed',muted:'#fed7aa',accent:'#f9a8d4',radius:18,blur:6}
  };
  const FONT_URLS = {
    inter:'https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap',
    rubik:'https://fonts.googleapis.com/css2?family=Rubik:wght@600;800&display=swap',
    montserrat:'https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap',
    poppins:'https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&display=swap',
    firasans:'https://fonts.googleapis.com/css2?family=Fira+Sans:wght@600;800&display=swap'
  };
  const getBool = (key, def=true) => {
    const v = p.get(key);
    if (v === null) return def;
    return !(v === '0' || v === 'false' || v === 'off');
  };

  function applyVars(v){
    if(!v) return;
    if(v.panel){ rootStyle.setProperty('--panel', v.panel); }
    if(v.text){  rootStyle.setProperty('--text',  v.text); }
    if(v.muted){ rootStyle.setProperty('--muted', v.muted); }
    if(v.accent){rootStyle.setProperty('--accent',v.accent); }
    if(v.radius!=null) rootStyle.setProperty('--radius', v.radius+'px');
    if(v.blur!=null)   rootStyle.setProperty('--blur',   v.blur+'px');
    if(v.bar!=null)    rootStyle.setProperty('--bar-h',  v.bar+'px');
    if(v.shadow===0)   rootStyle.setProperty('--shadow','none');
  }
  function applyFont(name){
    if(!name) return;
    const key=name.toLowerCase(), href=FONT_URLS[key];
    if(href){
      const link=document.createElement('link'); link.rel='stylesheet'; link.href=href; document.head.appendChild(link);
      const fam={inter:'"Inter"',rubik:'"Rubik"',montserrat:'"Montserrat"',poppins:'"Poppins"',firasans:'"Fira Sans"'}[key];
      if(fam) rootStyle.setProperty('--font', `${fam}, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`);
    }
  }

  /* ---------- Apply layout + theme FIRST ---------- */
  const layout = (p.get('layout')||'record').toLowerCase();
  const align = (p.get('align')||'left').toLowerCase(); // left|right (record/card)
  document.body.className = `layout-${layout} ${align}`;
  applyVars(THEMES[(p.get('theme')||'spotify').toLowerCase()]);

  // Show proper media element
  if(layout==='card'){ discEl.style.display='none'; artbox.classList.remove('hidden'); }
  if(layout!=='record'){ tonearm.style.display='none'; }

  /* ---------- Overrides (colors / sizes) ---------- */
  const map={accent:'--accent',panel:'--panel',text:'--text',muted:'--muted'};
  for (const [k,css] of Object.entries(map)){ const v=p.get(k); if(v) rootStyle.setProperty(css,v); }
  if(p.get('radius')) rootStyle.setProperty('--radius',p.get('radius')+'px');
  if(p.get('blur'))   rootStyle.setProperty('--blur',p.get('blur')+'px');
  if(p.get('bar'))    rootStyle.setProperty('--bar-h',p.get('bar')+'px');
  if(p.get('disc')||p.get('art')) rootStyle.setProperty('--disc',(p.get('disc')||p.get('art'))+'px');
  if(p.get('pad'))    rootStyle.setProperty('--pad', p.get('pad')+'px');
  if(p.get('shadow')==='0') rootStyle.setProperty('--shadow','none');
  if(p.get('outline')) rootStyle.setProperty('--outline', p.get('outline')+'px');
  if(p.get('marq'))    rootStyle.setProperty('--marq-s', p.get('marq')+'s');

  // Accent style
  const astyle = (p.get('accentstyle')||'solid').toLowerCase();
  if(astyle==='glow') document.body.classList.add('accent-glow');
  if(astyle==='gradient') document.body.classList.add('accent-gradient');

  // Compact mode
  if(getBool('compact', false)) wrap.classList.add('compact');

  // Label upright
  if((p.get('label')||'')==='static') discEl.classList.add('label-static');

  // Tonearm toggle
  if(!getBool('tonearm', true)) tonearm.style.display='none';

  // Transparent preset (apply AFTER theme/overrides)
  if(getBool('transparent', false)){
    rootStyle.setProperty('--panel','rgba(0,0,0,0)');
    rootStyle.setProperty('--blur','0px');
    rootStyle.setProperty('--shadow','none');
    rootStyle.setProperty('--radius','0px');
  }

  // Fonts
  applyFont(p.get('font'));

  /* ---------- Elements toggles (robust) ---------- */
  const toggle = (id, show) => { const n=$(id); if(!n) return; n.style.display = show ? '' : 'none'; };
  toggle('statusRow',  getBool('showstatus',  true));
  toggle('progress',   getBool('showprogress',true));
  toggle('timeRow',    getBool('showtime',    true));
  toggle('title',      getBool('title',       true));
  toggle('artist',     getBool('artist',      true));

  // Next line: default ON only for stacked unless &next=0. If &next=1, force ON anywhere.
  const nextParam = p.get('next');
  const showNext = (nextParam==='1') || (nextParam===null && layout==='stacked');
  toggle('nextRow', showNext);

  // Marquee default ON unless scroll=0
  const scrollOn = getBool('scroll', true);

  // Spin default ON unless spin=0
  const spinOn = getBool('spin', true);

  /* ---------- Spotify + Demo ---------- */
  const SCOPES=['user-read-playback-state','user-read-currently-playing']; // queue: same scope currently returns device/queue in many regions
  const TOKEN_URL='https://accounts.spotify.com/api/token';
  const AUTH_URL='https://accounts.spotify.com/authorize';
  const REDIRECT_URI=window.location.origin+window.location.pathname;

  const titleEl=$('title'), artistEl=$('artist'), statusEl=$('status'),
        barEl=$('bar'), elapsedEl=$('elapsed'), durationEl=$('duration'), labelDiv=$('labelImg');

  let accessToken=null, refreshToken=null, expiresAt=0;
  let playing=false, progressMs=0, durationMs=0;

  const K={clientId:'obs_spotify_client_id',verifier:'obs_spotify_code_verifier',access:'obs_spotify_access_token',refresh:'obs_spotify_refresh_token',expires:'obs_spotify_expires_at'};

  const sha256 = async (str)=>{ const buf=new TextEncoder().encode(str); const d=await crypto.subtle.digest('SHA-256',buf); return new Uint8Array(d); };
  const base64url = (bytes)=> btoa(String.fromCharCode(...bytes)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  const randString=(n=64)=>{ const a=new Uint8Array(n); crypto.getRandomValues(a); return base64url(a).slice(0,n); };
  const msToClock=(ms)=>{ ms=Math.max(0,Math.floor(ms)); const t=Math.floor(ms/1000); const m=Math.floor(t/60); const s=t%60; return `${m}:${s.toString().padStart(2,'0')}`; };
  function setProgress(pct){ const c=Math.max(0,Math.min(1,pct)); barEl.style.inset=`0 ${(1-c)*100}% 0 0`; elapsedEl.textContent=msToClock(progressMs); durationEl.textContent=msToClock(durationMs); }
  const setStatus=(t)=> statusEl.textContent=t;
  const showSetup=(b)=> $('setup').classList.toggle('hidden', !b);

  function loadStored(){ accessToken=localStorage.getItem(K.access); refreshToken=localStorage.getItem(K.refresh); expiresAt=parseInt(localStorage.getItem(K.expires)||'0',10); return !!accessToken; }
  function saveTokens(a,r,e){ if(a){accessToken=a;localStorage.setItem(K.access,a);} if(r){refreshToken=r;localStorage.setItem(K.refresh,r);} if(e){expiresAt=Date.now()+e*1000-10000; localStorage.setItem(K.expires',String(expiresAt));} }

  async function fetchJSON(url,opts={}){ const res=await fetch(url,opts); if(res.status===204) return null; if(!res.ok) throw new Error(`HTTP ${res.status}`); return await res.json(); }
  async function refresh(){
    const cid=localStorage.getItem(K.clientId); if(!refreshToken||!cid) return;
    const body=new URLSearchParams({client_id:cid,grant_type:'refresh_token',refresh_token:refreshToken});
    try{ const tok=await fetchJSON(TOKEN_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
         if(tok.access_token) localStorage.setItem(K.access, tok.access_token);
         if(tok.refresh_token) localStorage.setItem(K.refresh,tok.refresh_token);
         if(tok.expires_in)    localStorage.setItem(K.expires, String(Date.now()+tok.expires_in*1000-10000));
    }catch(e){ console.error('Refresh failed', e); setStatus('Refresh failed'); }
  }
  async function ensureToken(){
    const cid=localStorage.getItem(K.clientId);
    if(!cid){ showSetup(true); setStatus('Setup required'); return false; }
    const url=new URL(location.href); const code=url.searchParams.get('code'); const err=url.searchParams.get('error');
    if(err){ showSetup(true); setStatus('Auth error'); console.error('Auth error:',err); return false; }
    if(code){
      const verifier=localStorage.getItem(K.verifier);
      try{
        const body=new URLSearchParams({client_id:cid,grant_type:'authorization_code',code,redirect_uri:REDIRECT_URI,code_verifier:verifier});
        const tok=await fetchJSON(TOKEN_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
        if(tok.access_token) localStorage.setItem(K.access, tok.access_token);
        if(tok.refresh_token) localStorage.setItem(K.refresh,tok.refresh_token);
        if(tok.expires_in)    localStorage.setItem(K.expires, String(Date.now()+tok.expires_in*1000-10000));
        history.replaceState({},'',REDIRECT_URI);
      }catch(e){ console.error(e); showSetup(true); setStatus('Token exchange failed'); return false; }
    }
    loadStored(); if(!accessToken){ if(refreshToken){ await refresh(); loadStored(); } else { showSetup(true); setStatus('Not connected'); return false; } }
    if(Date.now()>expiresAt) await refresh();
    return true;
  }

  function setMarquee(el, text, enable){
    if(!enable){ el.classList.remove('marquee'); el.textContent=text; return; }
    el.classList.remove('marquee'); el.textContent=text;
    requestAnimationFrame(()=>{
      if (el.scrollWidth > el.clientWidth + 8){
        el.classList.add('marquee');
        el.innerHTML=''; const s1=document.createElement('span'); s1.textContent=text+'   •   '; const s2=s1.cloneNode(true); el.appendChild(s1); el.appendChild(s2);
      }
    });
  }

  function autoAccentFromImage(url){
    // Only if explicitly enabled (&autoaccent=1)
    if(!getBool('autoaccent', false)) return;
    try{
      const img=new Image(); img.crossOrigin='anonymous';
      img.onload=()=>{
        const c=document.createElement('canvas'), ctx=c.getContext('2d'); const w=48,h=48; c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h);
        const d=ctx.getImageData(0,0,w,h).data; let r=0,g=0,b=0,n=0;
        for(let i=0;i<d.length;i+=4){ const A=d[i+3]; if(A<12) continue; r+=d[i]; g+=d[i+1]; b+=d[i+2]; n++; }
        if(n){ r=Math.round(r/n); g=Math.round(g/n); b=Math.round(b/n); rootStyle.setProperty('--accent', `rgb(${r},${g},${b})`); }
      };
      img.src=url;
    }catch(e){}
  }

  function renderNothing(){
    playing=false; setMarquee($('title'),'Nothing playing',false); setMarquee($('artist'),'—',false);
    setStatus('Paused'); durationMs=progressMs=0; setProgress(0); discEl.classList.remove('spin'); $('labelImg').style.backgroundImage=''; artbox.style.backgroundImage='';
    if(nextRow) nextRow.classList.add('hidden');
  }

  function renderTrack(payload){
    const item=payload?.item; if(!item){ renderNothing(); return; }
    const img=(item.album?.images?.[0]?.url)||(item.album?.images?.[1]?.url)||(item.album?.images?.[2]?.url)||'';
    if(img){ $('labelImg').style.backgroundImage=`url('${img}')`; artbox.style.backgroundImage=`url('${img}')`; autoAccentFromImage(img); }
    const artists=(item.artists||[]).map(a=>a.name).join(', ');
    setMarquee($('title'), item.name || 'Untitled', true && scrollOn);
    setMarquee($('artist'), artists || 'Unknown artist', true && scrollOn);
    playing=!!payload.is_playing; setStatus(playing?'Playing':'Paused');
    discEl.classList.toggle('spin', playing && spinOn);
    durationMs=item.duration_ms||0; progressMs=payload.progress_ms||0; setProgress(durationMs?progressMs/durationMs:0);
  }

  async function getJSON(url){ return fetchJSON(url,{ headers:{ Authorization:`Bearer ${accessToken}` } }); }
  async function getCurrentlyPlaying(){ try{ return await getJSON('https://api.spotify.com/v1/me/player/currently-playing'); } catch(e){ if(String(e).includes('401')) await refresh(); return null; } }
  async function getQueue(){ try{ return await getJSON('https://api.spotify.com/v1/me/player/queue'); } catch(e){ return null; } }

  async function renderNext(){
    if(!nextRow || nextRow.style.display==='none') return;
    const q=await getQueue(); const nx=q?.queue?.[0];
    if(nx){ const a=(nx.artists||[]).map(x=>x.name).join(', '); nextRow.textContent=`Next: ${nx.name||'Unknown'} — ${a||''}`; }
  }

  function initSetup(){
    const id=$('clientId'), save=$('save'), conn=$('connect');
    id.value=localStorage.getItem(K.clientId)||'';
    save.onclick=()=>{ const v=id.value.trim(); if(!v) return alert('Please paste your Spotify Client ID'); localStorage.setItem(K.clientId,v); alert('Saved! Now click Connect to Spotify.'); };
    conn.onclick=async()=>{ const cid=localStorage.getItem(K.clientId); if(!cid) return alert('Save your Client ID first.');
      const verifier=randString(64); const challenge=await sha256(verifier).then(buf=>base64url(buf)); localStorage.setItem(K.verifier,verifier);
      const a=new URL('https://accounts.spotify.com/authorize'); a.searchParams.set('response_type','code'); a.searchParams.set('client_id',cid);
      a.searchParams.set('redirect_uri',REDIRECT_URI); a.searchParams.set('scope',SCOPES.join(' ')); a.searchParams.set('code_challenge_method','S256'); a.searchParams.set('code_challenge',challenge);
      location.href=a.toString();
    };
  }

  /* Demo mode for configurator */
  const demoMode = getBool('demo', false);
  function startDemo(){
    showSetup(false);
    const demoImg='https://i.scdn.co/image/ab67616d0000b273f0f0f0f0f0f0f0f0f0f0f0f0'; // placeholder public art
    const demo={ item:{ name:'Midnight Drive (Demo)', artists:[{name:'Lumen & Co'}], duration_ms:212000, album:{images:[{url:demoImg}] } }, is_playing:true, progress_ms:42000 };
    renderTrack(demo);
    setInterval(()=>{ playing=true; progressMs+=250; if(progressMs>durationMs) progressMs=0; setProgress(progressMs/durationMs); },250);
  }

  // Apply accent style to bar/dots now that CSS vars set
  const astyle = (p.get('accentstyle')||'solid').toLowerCase();
  if(astyle==='glow') document.body.classList.add('accent-glow');
  if(astyle==='gradient') document.body.classList.add('accent-gradient');

  // Alignment class (for grids)
  document.body.classList.add(`layout-${layout}`, align);

  // Optional debug overlay
  if(getBool('debug', false)){
    const dbg=document.createElement('div'); dbg.id='debug';
    dbg.textContent=`theme=${p.get('theme')||'spotify'} | align=${align} | accent=${getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()} | panel=${getComputedStyle(document.documentElement).getPropertyValue('--panel').trim()}`;
    document.body.appendChild(dbg);
  }

  (async function main(){
    initSetup();
    if(demoMode){ startDemo(); return; }

    const ok=await ensureToken();
    showSetup(!ok);
    setInterval(async()=>{ const data=await getCurrentlyPlaying(); if(!data){ renderNothing(); return; } renderTrack(data); }, 3000);
    setInterval(()=>{ if(playing && durationMs>0){ progressMs+=250; if(progressMs>durationMs) progressMs=durationMs; setProgress(progressMs/durationMs); } }, 250);
    if(showNext){ await renderNext(); setInterval(renderNext, 15000); }
  })();
</script>
</body>
</html>
