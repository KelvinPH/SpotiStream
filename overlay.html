<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SpotiStream â€“ Spotify Now Playing</title>
<style>
  :root{
    --bg: rgba(0,0,0,0);
    --panel: rgba(18,18,18,0.72);
    --text: #eaeaea; --muted:#b6bcc4; --accent:#1db954;
    --shadow: 0 12px 36px rgba(0,0,0,0.35);
    --radius: 16px; --blur: 8px;
    --disc: 200px; --bar-h: 6px; --gap: 22px; --max-w: 1100px; --pad:16px;
    --font: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    --title-size: clamp(18px,2.8vw,24px); --artist-size: clamp(12px,2vw,15px);
    --outline: 0px;   /* text outline */
    --marq-s: 18s;    /* marquee speed */
    --progress-width: 100%;  /* progress bar width */
    --text-align: left;      /* text alignment */
  }
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:600 14px/1.45 var(--font); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; overflow:hidden;}

  /* Panel */
  .wrap{width:100%; height:100%; box-sizing:border-box; padding:var(--pad);
        display:flex; align-items:center; justify-content:center;
        backdrop-filter: blur(var(--blur)) saturate(120%);
        background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow);}
  .inner{width:100%; max-width: var(--max-w); display:grid; gap: var(--gap); align-items:center;}

  /* Layouts + media placement */
  .layout-record.left  .inner{grid-template-columns: var(--disc) minmax(320px,1fr); grid-template-areas: "disc meta";}
  .layout-record.right .inner{grid-template-columns: minmax(320px,1fr) var(--disc); grid-template-areas: "meta disc";}
  .layout-card.left    .inner{grid-template-columns: var(--disc) minmax(320px,1fr); grid-template-areas: "art meta";}
  .layout-card.right   .inner{grid-template-columns: minmax(320px,1fr) var(--disc); grid-template-areas: "meta art";}
  .layout-bar          .inner{grid-template-columns:1fr; grid-template-areas:"meta"; padding:4px 0;}
  .layout-stacked      .inner{grid-template-columns:1fr; grid-template-areas:"disc" "meta"; place-items:center; text-align:center;}
  
  /* New Creative Layouts */
  .layout-compact      .inner{grid-template-columns: 80px 1fr; grid-template-areas: "art meta"; gap:12px; padding:8px;}
  .layout-compact .disc, .layout-compact .artbox{width:80px; height:80px;}
  .layout-compact .wrap{padding:8px;}
  
  .layout-wide         .inner{grid-template-columns: var(--disc) 1fr var(--disc); grid-template-areas: "art meta art2"; gap:32px;}
  .layout-wide .artbox:last-child{grid-area:art2; opacity:0.3; filter:blur(2px);}
  
  .layout-split.left   .inner{grid-template-columns: 1fr; grid-template-areas: "art" "meta"; gap:16px; text-align:center;}
  .layout-split.right  .inner{grid-template-columns: 1fr; grid-template-areas: "meta" "art"; gap:16px; text-align:center;}
  .layout-split.center .inner{grid-template-columns: 1fr; grid-template-areas: "art" "meta"; gap:16px; text-align:center;}
  .layout-split.top    .inner{grid-template-columns: 1fr; grid-template-areas: "art" "meta"; gap:16px; text-align:center;}
  .layout-split.bottom .inner{grid-template-columns: 1fr; grid-template-areas: "meta" "art"; gap:16px; text-align:center;}
  
  .layout-floating     .wrap{position:fixed; top:20px; right:20px; width:300px; height:auto; backdrop-filter:blur(20px); z-index:999;}
  .layout-floating     .inner{width:100%; max-width:none;}
  
  .layout-corner       .inner{grid-template-columns: 60px 1fr; grid-template-areas: "art meta"; gap:8px; padding:6px;}
  .layout-corner .disc, .layout-corner .artbox{width:60px; height:60px;}
  .layout-corner .wrap{padding:6px; position:fixed; bottom:20px; right:20px; width:280px; height:auto;}
  
  .layout-ticker       .inner{grid-template-columns: 60px 1fr; grid-template-areas: "art meta"; gap:12px; padding:8px 16px;}
  .layout-ticker .meta{overflow:hidden; white-space:nowrap;}
  .layout-ticker .title, .layout-ticker .artist{
    display:inline-block; 
    animation: scroll-left 20s linear infinite;
    white-space:nowrap;
  }
  .layout-ticker .wrap{position:fixed; bottom:0; left:0; right:0; width:100%; border-radius:0; height:auto;}
  
  @keyframes scroll-left{from{transform:translateX(100%)} to{transform:translateX(-100%)}}
  
  .layout-bar .pill, .layout-bar .disc, .layout-bar .artbox{display:none}
  .layout-compact .pill{display:none}
  .layout-corner .pill, .layout-corner .progress, .layout-corner .time{display:none}
  .layout-ticker .pill, .layout-ticker .progress, .layout-ticker .time{display:none}
  .layout-floating .pill{font-size:12px; padding:4px 8px;}
  .layout-split .pill{margin:0 auto;}

  .meta{grid-area:meta; min-width:0; display:grid; gap:10px; align-content:center; z-index:2}
  .disc, .artbox{z-index:1}

  /* Vinyl */
  .disc{grid-area:disc; position:relative; width:var(--disc); height:var(--disc); border-radius:50%;
        background:
         radial-gradient(circle at 50% 50%, rgba(255,255,255,0.07) 0 6%, transparent 6%),
         repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,0.08) 0 1px, transparent 2px 6px), #0f0f0f;
        box-shadow: inset 0 0 30px rgba(0,0,0,0.7), 0 12px 30px rgba(0,0,0,0.4);
        display:grid; place-items:center; overflow:hidden;}
  .disc::before{content:""; position:absolute; inset:-18%;
        background: radial-gradient(circle at 18% 22%, rgba(255,255,255,0.08), transparent 50%),
                    radial-gradient(circle at 80% 78%, rgba(255,255,255,0.06), transparent 50%);
        border-radius:50%; z-index:1; animation: sheen 9s linear infinite;}
  @keyframes sheen{from{transform:rotate(0)} to{transform:rotate(360deg)}}
  .label-img{width:62%; height:62%; border-radius:50%; background:#222 center/cover no-repeat;
             box-shadow:0 2px 10px rgba(0,0,0,0.35); position:relative; z-index:2;}
  .label-static .label-img{animation: spin 9s linear infinite reverse;}
  .disc::after{content:""; position:absolute; width:8px; height:8px; border-radius:50%; background:#000; box-shadow:0 0 0 1px rgba(255,255,255,0.28); z-index:3;}
  .spin .label-img, .spin::before{animation: spin 9s linear infinite}
  @keyframes spin{from{transform:rotate(0)} to{transform:rotate(360deg)}}
  .tonearm{position:absolute; right:-26px; top:14px; width:136px; height:26px; transform:rotate(21deg);
           transform-origin:left center; pointer-events:none; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.5));}
  .tonearm .arm{position:absolute; left:0; top:10px; width:116px; height:6px; background:linear-gradient(#cfcfcf,#969696); border-radius:4px}
  .tonearm .head{position:absolute; right:0; top:6px; width:22px; height:14px; background:linear-gradient(#666,#333); border-radius:3px}
  .tonearm .joint{position:absolute; left:-8px; top:6px; width:14px; height:14px; border-radius:50%; background:#a7a7a7; box-shadow: inset 0 1px 2px rgba(0,0,0,0.45)}

  /* Card art */
  .artbox{grid-area:art; width:var(--disc); height:var(--disc); border-radius:12px; overflow:hidden;
          background:#222 center/cover no-repeat; box-shadow: 0 10px 30px rgba(0,0,0,0.38);}

  /* Text / progress */
  .title,.artist{white-space:nowrap; overflow:hidden}
  .title{font-size:var(--title-size); font-weight:800; letter-spacing:0.2px;
         -webkit-mask-image: linear-gradient(90deg,#000 90%,transparent 100%);
         mask-image: linear-gradient(90deg,#000 90%,transparent 100%);
         text-shadow:0 0 var(--outline) #000;}
  .artist{font-size:var(--artist-size); color:var(--muted);
          -webkit-mask-image: linear-gradient(90deg,#000 92%,transparent 100%);
          mask-image: linear-gradient(90deg,#000 92%,transparent 100%);
          text-shadow:0 0 var(--outline) #000;}
  .row{display:flex; align-items:center; gap:8px}
  .pill{display:inline-flex; align-items:center; gap:8px; background: rgba(255,255,255,0.08); padding:6px 10px; border-radius:999px}
  .dot{width:6px; height:6px; border-radius:999px; background:var(--accent); box-shadow:0 0 8px var(--accent)}
  .progress{height:var(--bar-h); border-radius:999px; position:relative; overflow:hidden; background: rgba(255,255,255,0.18); width: var(--progress-width)}
  .bar{position:absolute; inset:0 100% 0 0; border-radius:999px; background: var(--accent)}
  .time{display:flex; justify-content:space-between; font-variant-numeric:tabular-nums; color:var(--muted); width: var(--progress-width)}
  
  /* Text alignment classes */
  .text-left .meta { text-align: left; align-items: flex-start; }
  .text-left .progress, .text-left .time { margin-left: 0; margin-right: auto; }
  .text-left .row { justify-content: flex-start; }
  
  .text-center .meta { text-align: center; align-items: center; }
  .text-center .progress, .text-center .time { margin: 0 auto; }
  .text-center .row { justify-content: center; }
  
  .text-right .meta { text-align: right; align-items: flex-end; }
  .text-right .progress, .text-right .time { margin-left: auto; margin-right: 0; }
  .text-right .row { justify-content: flex-end; }
  .next{font-size:12px; color:var(--muted)}

  /* Accent styles */
  .accent-glow .dot{ box-shadow:0 0 12px var(--accent), 0 0 24px var(--accent); }
  .accent-gradient .bar{ background: linear-gradient(90deg, var(--accent), rgba(255,255,255,0.9)); }

  /* Marquee */
  .marquee{ position:relative; overflow:hidden; }
  .marquee span{ display:inline-block; padding-right:60px; will-change:transform; animation:marquee var(--marq-s) linear infinite; }
  @keyframes marquee{ from{ transform:translateX(0) } to{ transform:translateX(-50%) } }

  .btn{appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer; background:var(--accent); color:#000; box-shadow: var(--shadow)}
  .setup{display:grid; gap:12px}
  .field{display:grid; gap:6px}
  .input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color:var(--text)}
  .hidden{display:none !important}

  .compact.wrap{padding:10px 12px}
  .compact .inner{gap:14px}
  .compact .title{--title-size: clamp(16px,2.2vw,20px)}
  .compact .artist{--artist-size: clamp(11px,1.7vw,13px)}

  @media (max-width:560px){ :root{--disc:150px} .tonearm{display:none} }
</style>
</head>
<body>
  <div id="card" class="wrap">
    <div id="inner" class="inner">
      <div id="disc" class="disc spin">
        <div id="labelImg" class="label-img"></div>
        <div id="tonearm" class="tonearm"><div class="arm"></div><div class="head"></div><div class="joint"></div></div>
      </div>
      <div id="artbox" class="artbox hidden"></div>
      <div class="meta">
        <div id="statusRow" class="row"><div class="pill"><span class="dot"></span><span id="status">Paused</span></div></div>
        <div id="title" class="title">Nothing playing</div>
        <div id="artist" class="artist">â€”</div>
        <div id="progress" class="progress" title="Progress"><div id="bar" class="bar"></div></div>
        <div id="timeRow" class="time"><div id="elapsed">0:00</div><div id="duration">0:00</div></div>
        <div id="nextRow" class="next hidden"></div>
        <div id="setup" class="setup hidden">
          <div class="field"><label for="clientId">Spotify Client ID</label><input id="clientId" class="input" placeholder="paste your Client ID"/></div>
          <button id="save" class="btn">Save Client ID</button>
          <button id="connect" class="btn">Connect to Spotify</button>
          <small class="artist">Redirect URI must exactly match this page URL (ends with <code>/overlay.html</code>).</small>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- utilities ---------- */
const p = new URLSearchParams(location.search);
const $ = id => document.getElementById(id);
const root = document.documentElement.style;

const THEMES = {
  spotify:{panel:'rgba(18,18,18,0.72)',text:'#eaeaea',muted:'#b6bcc4',accent:'#1db954',radius:16,blur:8},
  obsdark:{panel:'rgba(24,24,27,0.72)',text:'#e6e7ea',muted:'#9da3ad',accent:'#22d3ee',radius:14,blur:6},
  minimal:{panel:'rgba(0,0,0,0.34)',text:'#ffffff',muted:'#cfcfcf',accent:'#ffffff',radius:12,blur:2,bar:4,shadow:0},
  neon:{panel:'rgba(8,10,22,0.62)',text:'#e9f0ff',muted:'#9ab0ff',accent:'#7cf4ff',radius:14,blur:10},
  oldradio:{panel:'rgba(64,50,34,0.62)',text:'#fff7e6',muted:'#eed9b7',accent:'#ffb84d',radius:12,blur:3,bar:4},
  blue:{panel:'rgba(10,24,48,0.55)',text:'#e6f0ff',muted:'#a9c1ff',accent:'#4da3ff',radius:16,blur:8},
  red:{panel:'rgba(48,12,18,0.52)',text:'#ffeaea',muted:'#ffb3b3',accent:'#ff4d4d',radius:16,blur:8},
  yellow:{panel:'rgba(48,40,12,0.52)',text:'#fff9db',muted:'#ffe7a3',accent:'#ffd43b',radius:16,blur:8},
  slate:{panel:'rgba(0,0,0,0.55)',text:'#ffffff',muted:'#c7c7c7',accent:'#1db954',radius:16,blur:6},
  twitch:{panel:'rgba(16,12,26,0.66)',text:'#ede9fe',muted:'#c4b5fd',accent:'#9146FF',radius:16,blur:8},
  ytred:{panel:'rgba(26,8,8,0.66)',text:'#ffecec',muted:'#ffb4b4',accent:'#FF0033',radius:16,blur:8},
  aqua:{panel:'rgba(10,24,24,0.55)',text:'#e6fffb',muted:'#a8fff2',accent:'#12d6c5',radius:16,blur:8},
  cyber:{panel:'rgba(6,8,18,0.62)',text:'#d9f2ff',muted:'#8dd6ff',accent:'#00ffe1',radius:16,blur:10},
  pastel:{panel:'rgba(28,25,23,0.45)',text:'#fff7ed',muted:'#fed7aa',accent:'#f9a8d4',radius:18,blur:6},
  
  // New Creative Themes
  gaming:{panel:'rgba(0,0,0,0.85)',text:'#00ff88',muted:'#66ffaa',accent:'#ff0066',radius:16,blur:12},
  lofi:{panel:'rgba(42,24,16,0.6)',text:'#f4e4c1',muted:'#d4b896',accent:'#e67e22',radius:20,blur:4},
  retro:{panel:'rgba(26,10,42,0.7)',text:'#ff6ec7',muted:'#c77dff',accent:'#7209b7',radius:12,blur:6},
  elegant:{panel:'rgba(248,249,250,0.9)',text:'#1a202c',muted:'#4a5568',accent:'#3182ce',radius:18,blur:8},
  party:{panel:'rgba(0,0,0,0.8)',text:'#ffffff',muted:'#cccccc',accent:'#ff1493',radius:16,blur:10},
  cozy:{panel:'rgba(45,24,16,0.65)',text:'#f7e6d3',muted:'#d4b896',accent:'#cd853f',radius:16,blur:6},
  focus:{panel:'rgba(0,0,0,0.3)',text:'#e2e8f0',muted:'#a0aec0',accent:'#4299e1',radius:8,blur:2},
  sunset:{panel:'rgba(255,94,77,0.2)',text:'#2d3748',muted:'#4a5568',accent:'#ed8936',radius:16,blur:8},
  ocean:{panel:'rgba(0,119,190,0.3)',text:'#ffffff',muted:'#b3d9ff',accent:'#00d4ff',radius:16,blur:8},
  forest:{panel:'rgba(34,139,34,0.3)',text:'#f0fff0',muted:'#98fb98',accent:'#32cd32',radius:16,blur:6},
  midnight:{panel:'rgba(25,25,112,0.4)',text:'#e6e6fa',muted:'#c5c5ff',accent:'#9370db',radius:16,blur:10},
  aurora:{panel:'rgba(0,100,100,0.3)',text:'#f0ffff',muted:'#afeeee',accent:'#40e0d0',radius:18,blur:8},
  gradient:{panel:'linear-gradient(135deg, rgba(255,0,150,0.3), rgba(0,204,255,0.3))',text:'#ffffff',muted:'#e0e0e0',accent:'#ff6b9d',radius:16,blur:8},
  monochrome:{panel:'rgba(0,0,0,0.2)',text:'#ffffff',muted:'#888888',accent:'#ffffff',radius:4,blur:0,shadow:0}
};
const FONTS = {
  inter:'https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap',
  rubik:'https://fonts.googleapis.com/css2?family=Rubik:wght@600;800&display=swap',
  montserrat:'https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap',
  poppins:'https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&display=swap',
  firasans:'https://fonts.googleapis.com/css2?family=Fira+Sans:wght@600;800&display=swap'
};
const getBool=(key,def=true)=>{ const v=p.get(key); if(v===null) return def; return !(v==='0'||v==='false'||v==='off'); };
const applyVars=v=>{ if(!v) return;
  if(v.panel)root.setProperty('--panel',v.panel); if(v.text)root.setProperty('--text',v.text);
  if(v.muted)root.setProperty('--muted',v.muted); if(v.accent)root.setProperty('--accent',v.accent);
  if(v.radius!=null)root.setProperty('--radius',v.radius+'px'); if(v.blur!=null)root.setProperty('--blur',v.blur+'px');
  if(v.bar!=null)root.setProperty('--bar-h',v.bar+'px'); if(v.shadow===0)root.setProperty('--shadow','none'); };
const applyFont=name=>{ if(!name) return; const href=FONTS[name.toLowerCase()]; if(href){ const link=document.createElement('link'); link.rel='stylesheet'; link.href=href; document.head.appendChild(link);
  const fam={inter:'"Inter"',rubik:'"Rubik"',montserrat:'"Montserrat"',poppins:'"Poppins"',firasans:'"Fira Sans"'}[name.toLowerCase()];
  if(fam) root.setProperty('--font', `${fam}, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`);} };

/* ---------- layout + theme ---------- */
const layout=(p.get('layout')||'record').toLowerCase();
const align =(p.get('align') ||'left').toLowerCase();
document.body.className=`layout-${layout} ${align}`;
applyVars(THEMES[(p.get('theme')||'spotify').toLowerCase()]);

const discEl=$('disc'), artbox=$('artbox'), tonearm=$('tonearm');

// Layout-specific element handling
if(layout==='card'){ 
  discEl.style.display='none'; 
  artbox.classList.remove('hidden'); 
}
if(layout==='compact' || layout==='corner' || layout==='ticker' || layout==='split' || layout==='floating'){ 
  discEl.style.display='none'; 
  artbox.classList.remove('hidden'); 
}
if(layout==='wide'){
  discEl.style.display='none'; 
  artbox.classList.remove('hidden');
  // Create duplicate artbox for wide layout
  const artbox2 = artbox.cloneNode(true);
  artbox2.id = 'artbox2';
  artbox.parentNode.appendChild(artbox2);
}
if(layout!=='record'){ 
  tonearm.style.display='none'; 
}

/* overrides */
const map={accent:'--accent',panel:'--panel',text:'--text',muted:'--muted'};
for(const [k,css] of Object.entries(map)){ const v=p.get(k); if(v) root.setProperty(css,v); }
if(p.get('radius')) root.setProperty('--radius',p.get('radius')+'px');
if(p.get('blur'))   root.setProperty('--blur',p.get('blur')+'px');
if(p.get('bar'))    root.setProperty('--bar-h',p.get('bar')+'px');
if(p.get('disc')||p.get('art')) root.setProperty('--disc',(p.get('disc')||p.get('art'))+'px');
if(p.get('pad'))    root.setProperty('--pad', p.get('pad')+'px');
if(p.get('shadow')==='0') root.setProperty('--shadow','none');
if(p.get('outline')) root.setProperty('--outline', p.get('outline')+'px');
if(p.get('marq'))    root.setProperty('--marq-s', p.get('marq')+'s');
if(p.get('progresswidth')) root.setProperty('--progress-width', p.get('progresswidth')+'%');

if(getBool('compact',false)) $('card').classList.add('compact');
if((p.get('label')||'')==='static') discEl.classList.add('label-static');
if(!getBool('tonearm',true)) tonearm.style.display='none';

if(getBool('transparent',false)){
  root.setProperty('--panel','rgba(0,0,0,0)');
  root.setProperty('--blur','0px'); root.setProperty('--shadow','none'); root.setProperty('--radius','0px');
}
applyFont(p.get('font'));

/* text alignment */
const textAlign = p.get('textalign') || 'auto';
const mediaAlign = align; // 'left' or 'right'

if (textAlign === 'auto') {
  // Auto mode: text alignment follows media position for visual balance
  if (layout === 'stacked') {
    document.body.classList.add('text-center');
  } else if (layout === 'bar') {
    document.body.classList.add('text-left'); // bar layout always left
  } else if (mediaAlign === 'right') {
    document.body.classList.add('text-right'); // text follows media to right
  } else {
    document.body.classList.add('text-left'); // text follows media to left
  }
} else {
  // Manual alignment override
  document.body.classList.add(`text-${textAlign}`);
}

/* accent style */
const astyle=(p.get('accentstyle')||'solid').toLowerCase();
if(astyle==='glow') document.body.classList.add('accent-glow');
else if(astyle==='gradient') document.body.classList.add('accent-gradient');

/* element toggles */
const show=(id,flag)=>{ const n=$(id); if(!n) return; n.style.display = flag ? '' : 'none'; };
show('statusRow', getBool('showstatus',true));
show('progress',  getBool('showprogress',true));
show('timeRow',   getBool('showtime',true));
show('title',     getBool('title',true));
show('artist',    getBool('artist',true));
const nextParam=p.get('next'); const showNext=(nextParam==='1') || (nextParam===null && layout==='stacked');
show('nextRow', showNext);

const scrollOn=getBool('scroll',true);
const spinOn  =getBool('spin',true);
const autoAccent=getBool('autoaccent',false);

/* ---------- Spotify auth + data ---------- */
const SCOPES=['user-read-playback-state','user-read-currently-playing'];
const TOKEN_URL='https://accounts.spotify.com/api/token';
const AUTH_URL='https://accounts.spotify.com/authorize';
const REDIRECT_URI=window.location.origin+window.location.pathname;

const titleEl=$('title'), artistEl=$('artist'), statusEl=$('status'),
      barEl=$('bar'), elapsedEl=$('elapsed'), durationEl=$('duration'), labelDiv=$('labelImg');

let playing=false, progressMs=0, durationMs=0;

function msToClock(ms){ ms=Math.max(0,Math.floor(ms)); const t=Math.floor(ms/1000); const m=Math.floor(t/60); const s=t%60; return `${m}:${s.toString().padStart(2,'0')}`; }
function setProgress(pct){ const c=Math.max(0,Math.min(1,pct)); barEl.style.inset=`0 ${(1-c)*100}% 0 0`; elapsedEl.textContent=msToClock(progressMs); durationEl.textContent=msToClock(durationMs); }
function setStatus(t){ statusEl.textContent=t; }
function setMarquee(el,text,enable){
  if(!enable){ el.classList.remove('marquee'); el.textContent=text; return; }
  el.classList.remove('marquee'); el.textContent=text;
  requestAnimationFrame(()=>{ if(el.scrollWidth>el.clientWidth+8){ el.classList.add('marquee'); el.innerHTML=''; const s1=document.createElement('span'); s1.textContent=text+'   â€¢   '; const s2=s1.cloneNode(true); el.appendChild(s1); el.appendChild(s2);} });
}
function showSetup(b){ $('setup').classList.toggle('hidden',!b); }

function renderNothing(){
  playing=false; setMarquee($('title'),'Nothing playing',false); setMarquee($('artist'),'â€”',false);
  setStatus('Paused'); durationMs=progressMs=0; setProgress(0); discEl.classList.remove('spin');
  $('labelImg').style.backgroundImage=''; artbox.style.backgroundImage=''; $('nextRow').classList.add('hidden');
}
function renderTrack(payload){
  const item=payload?.item; if(!item){ renderNothing(); return; }
  const img=(item.album?.images?.[0]?.url)||(item.album?.images?.[1]?.url)||(item.album?.images?.[2]?.url)||'';
  if(img){ labelDiv.style.backgroundImage=`url('${img}')`; artbox.style.backgroundImage=`url('${img}')`;
    if(autoAccent){ try{ const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>{ const c=document.createElement('canvas'),x=c.getContext('2d'); c.width=48;c.height=48;x.drawImage(im,0,0,48,48); const d=x.getImageData(0,0,48,48).data; let r=0,g=0,b=0,n=0; for(let i=0;i<d.length;i+=4){ if(d[i+3]<12) continue; r+=d[i]; g+=d[i+1]; b+=d[i+2]; n++; } if(n){ r=(r/n)|0; g=(g/n)|0; b=(b/n)|0; root.setProperty('--accent',`rgb(${r},${g},${b})`);} }; im.src=img; }catch(e){} }
  }
  const artists=(item.artists||[]).map(a=>a.name).join(', ');
  setMarquee(titleEl, item.name||'Untitled', scrollOn);
  setMarquee(artistEl, artists||'Unknown artist', scrollOn);
  playing=!!payload.is_playing; setStatus(playing?'Playing':'Paused');
  discEl.classList.toggle('spin', playing && spinOn);
  durationMs=item.duration_ms||0; progressMs=payload.progress_ms||0; setProgress(durationMs?progressMs/durationMs:0);
}

/* OAuth+API storage keys */
const K={clientId:'obs_spotify_client_id', verifier:'obs_spotify_code_verifier',
         access:'obs_spotify_access_token', refresh:'obs_spotify_refresh_token', expires:'obs_spotify_expires_at'};

async function sha256(str){ const buf=new TextEncoder().encode(str); const d=await crypto.subtle.digest('SHA-256',buf); return new Uint8Array(d); }
function base64url(bytes){ return btoa(String.fromCharCode(...bytes)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function randString(n=64){ const a=new Uint8Array(n); crypto.getRandomValues(a); return base64url(a).slice(0,n); }

async function fetchJSON(url,opts={}){ const res=await fetch(url,opts); if(res.status===204) return null; if(!res.ok) throw new Error(`HTTP ${res.status}`); return await res.json(); }
async function refresh(){
  const cid=localStorage.getItem(K.clientId); const refreshToken=localStorage.getItem(K.refresh); if(!refreshToken||!cid) return;
  const body=new URLSearchParams({client_id:cid,grant_type:'refresh_token',refresh_token:refreshToken});
  try{
    const tok=await fetchJSON(TOKEN_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
    if(tok.access_token) localStorage.setItem(K.access,tok.access_token);
    if(tok.refresh_token) localStorage.setItem(K.refresh,tok.refresh_token);
    if(tok.expires_in)    localStorage.setItem(K.expires,String(Date.now()+tok.expires_in*1000-10000));
  }catch(e){ console.error('Refresh failed',e); setStatus('Refresh failed'); }
}
async function ensureToken(){
  const cid=localStorage.getItem(K.clientId);
  if(!cid){ showSetup(true); setStatus('Setup required'); return false; }
  const url=new URL(location.href); const code=url.searchParams.get('code'); const err=url.searchParams.get('error');
  if(err){ showSetup(true); setStatus('Auth error'); console.error('Spotify auth error:',err); return false; }
  if(code){
    const verifier=localStorage.getItem(K.verifier);
    try{
      const body=new URLSearchParams({client_id:cid,grant_type:'authorization_code',code,redirect_uri:REDIRECT_URI,code_verifier:verifier});
      const tok=await fetchJSON(TOKEN_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
      if(tok.access_token) localStorage.setItem(K.access,tok.access_token);
      if(tok.refresh_token) localStorage.setItem(K.refresh,tok.refresh_token);
      if(tok.expires_in)    localStorage.setItem(K.expires,String(Date.now()+tok.expires_in*1000-10000));
      history.replaceState({},'',REDIRECT_URI);
    }catch(e){ console.error(e); showSetup(true); setStatus('Token exchange failed'); return false; }
  }
  const access=localStorage.getItem(K.access); const refreshT=localStorage.getItem(K.refresh); const exp=parseInt(localStorage.getItem(K.expires)||'0',10);
  if(!access && !refreshT){ showSetup(true); setStatus('Not connected'); return false; }
  if(Date.now()>exp) await refresh();
  return true;
}

async function getJSON(url){ const token=localStorage.getItem(K.access); return fetchJSON(url,{ headers:{ Authorization:`Bearer ${token}` } }); }
async function getCurrentlyPlaying(){ try{ return await getJSON('https://api.spotify.com/v1/me/player/currently-playing'); } catch(e){ if(String(e).includes('401')) await refresh(); return null; } }
async function getQueue(){ try{ return await getJSON('https://api.spotify.com/v1/me/player/queue'); } catch(e){ return null; } }

/* setup buttons */
function initSetup(){
  const id=$('clientId'), save=$('save'), conn=$('connect');
  id.value=localStorage.getItem(K.clientId)||'';
  save.onclick=()=>{ const v=id.value.trim(); if(!v) return alert('Please paste your Spotify Client ID'); localStorage.setItem(K.clientId,v); alert('Saved! Now click Connect to Spotify.'); };
  conn.onclick=async()=>{ const cid=localStorage.getItem(K.clientId); if(!cid) return alert('Save your Client ID first.');
    const verifier=randString(64); const challenge=await sha256(verifier).then(buf=>base64url(buf)); localStorage.setItem(K.verifier,verifier);
    const a=new URL(AUTH_URL); a.searchParams.set('response_type','code'); a.searchParams.set('client_id',cid);
    a.searchParams.set('redirect_uri',REDIRECT_URI); a.searchParams.set('scope',SCOPES.join(' '));
    a.searchParams.set('code_challenge_method','S256'); a.searchParams.set('code_challenge',challenge);
    location.href=a.toString();
  };
}

/* demo mode */
const demo=getBool('demo',false);
function startDemo(){
  showSetup(false);
  const demoImg='https://i.scdn.co/image/ab67616d0000b273d4c3de2d8d1a6ca5b9e3b123';
  const payload={ item:{ name:'Midnight Drive (Demo)', artists:[{name:'Lumen & Co'}], duration_ms:212000, album:{images:[{url:demoImg}] } }, is_playing:true, progress_ms:42000 };
  renderTrack(payload);
  setInterval(()=>{ playing=true; progressMs+=250; if(progressMs>durationMs) progressMs=0; setProgress(progressMs/durationMs); },250);
}

/* main */
(async function main(){
  // apply accentstyle class (after DOM built)
  if(astyle==='glow') document.body.classList.add('accent-glow');
  else if(astyle==='gradient') document.body.classList.add('accent-gradient');

  initSetup();

  if(demo){ startDemo(); return; }

  const ok=await ensureToken(); showSetup(!ok);

  setInterval(async()=>{ const data=await getCurrentlyPlaying(); if(!data){ renderNothing(); return; } renderTrack(data); },3000);
  setInterval(()=>{ if(playing && durationMs>0){ progressMs+=250; if(progressMs>durationMs) progressMs=durationMs; setProgress(progressMs/durationMs); } },250);

  if(showNext){ const renderNext=async()=>{ try{ const q=await getQueue(); const nx=q?.queue?.[0]; if(nx){ const a=(nx.artists||[]).map(x=>x.name).join(', '); $('nextRow').textContent=`Next: ${nx.name||'Unknown'} â€” ${a||''}`; $('nextRow').classList.remove('hidden'); } }catch(e){} };
    renderNext(); setInterval(renderNext,15000);
  }
})();
</script>
</body>
</html>
